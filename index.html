<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CorAlma — Encuentra tu calma</title>
<meta name="description" content="Meditaciones, sonidos, artículos, tarot y playlists. Todo en una página." />
<!-- Font Awesome para iconos -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --bg1:#020414; --bg2:#041428;
  --accent1:#6ec6d9; --accent2:#8a6cff;
  --glass: rgba(255,255,255,0.04);
  --muted:#9fd8ea; --text:#e6f9ff;
  --finished:#ff6b6b;
  --card-bg: rgba(255,255,255,0.02);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;-webkit-font-smoothing:antialiased}
body{
  color:var(--text);
  background:
    radial-gradient(circle at 10% 10%, rgba(138,108,255,0.06), transparent 6%),
    radial-gradient(circle at 90% 70%, rgba(110,198,217,0.04), transparent 10%),
    linear-gradient(180deg,var(--bg1), var(--bg2));
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
  padding-bottom:60px;
}
.container{max-width:1180px;margin:24px auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021018}
nav{display:flex;gap:10px;align-items:center}
nav a{color:#cfeffb;text-decoration:none;padding:8px 10px;border-radius:9px}
nav a:hover{background:var(--glass)}

/* layout */
.grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-top:22px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:16px;border-radius:12px}
.med-card{padding:18px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);box-shadow:0 10px 40px rgba(15,30,50,0.45)}
.center{display:flex;flex-direction:column;align-items:center;gap:12px}
.btn-primary{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021018;padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}

/* Articles */
.articles-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px;max-height:320px;overflow:auto;padding-right:6px}
.article-card{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);text-align:left}
.article-card h3{margin:0 0 6px 0;font-size:16px}
.article-card p{margin:0;color:#cfeef7;font-size:14px}

/* YouTube playlists */
.playlists{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px}
.playlists iframe{width:100%;height:200px;border-radius:8px;border:0;}

/* Tarot */
#tarotSection{display:flex;flex-direction:column;align-items:center;gap:12px}
#mazo{width:180px;height:260px;border-radius:10px;background-image:linear-gradient(180deg,#2a1f44,#1b2633);display:flex;align-items:center;justify-content:center;box-shadow:0 12px 40px rgba(0,0,0,0.5);cursor:pointer;border:4px solid rgba(255,255,255,0.03)}
#cardReveal{width:220px;height:320px;border-radius:10px;object-fit:cover;box-shadow:0 18px 50px rgba(0,0,0,0.6);display:none}
#tarotText{max-width:560px;background:var(--card-bg);padding:12px;border-radius:10px;color:#dff8ff}

/* floating social bar */
.social-bar {
  position: fixed;
  top: 45%;
  right: 0;
  transform: translateY(-50%);
  display:flex;
  flex-direction:column;
  gap:10px;
  padding:8px;
  background:rgba(0,0,0,0.18);
  border-radius:12px 0 0 12px;
  z-index:1200;
}
.social-bar a{display:flex;align-items:center;justify-content:center;width:44px;height:44px;background:transparent;border-radius:8px;color:#fff;text-decoration:none}
.social-bar a:hover{background:rgba(255,255,255,0.04)}
.social-bar .pay{background:linear-gradient(90deg,#ffd100,#2d9cff);border-radius:10px;padding:8px}

/* floating draggable timer */
.floating-btn{position:fixed;right:20px;bottom:20px;width:120px;height:120px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#021018;font-weight:700;cursor:move;z-index:2000;box-shadow:0 12px 40px rgba(60,80,120,0.18);transition:background .25s}
.floating-btn.finished{background:var(--finished); color:#fff;}

/* responsive */
@media(max-width:980px){
  .grid{grid-template-columns:1fr}
  .articles-grid{grid-template-columns:1fr}
  #cardReveal{width:160px;height:240px}
  #mazo{width:140px;height:200px}
}
</style>
</head>
<body>
  <!-- Social bar -->
  <div class="social-bar" aria-hidden="false">
    <a href="https://www.instagram.com/effectno33" target="_blank" title="Instagram"><i class="fab fa-instagram" style="font-size:20px;"></i></a>
    <a href="https://www.tiktok.com/@effect.33" target="_blank" title="TikTok"><i class="fab fa-tiktok" style="font-size:20px;"></i></a>
    <a href="https://youtube.com/@effect.no33" target="_blank" title="YouTube"><i class="fab fa-youtube" style="font-size:20px;"></i></a>
    <a class="pay" href="https://www.paypal.com/donate/?hosted_button_id=GW4XCFHYRTJQQ" target="_blank" title="Donar con PayPal"><i class="fab fa-paypal" style="font-size:18px;color:#021018;"></i></a>
  </div>

  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">CA</div>
        <div>
          <h1>CorAlma</h1>
          <div style="font-size:12px;color:#bfeffd">Encuentra tu calma en el universo interior</div>
        </div>
      </div>
      <nav>
        <a href="#">Inicio</a>
        <a href="#medit-block">Meditación</a>
        <a href="#art">Artículos</a>
        <a href="#tarot">Tarot</a>
        <a href="#music">Música</a>
        <a href="#contact">Contacto</a>
      </nav>
    </header>

    <section class="hero card med-card" aria-labelledby="hero-title">
      <div class="hero-left">
        <h2 id="hero-title">Calma y presencia — prácticas basadas en ciencia y tradición</h2>
        <p>Sonidos de naturaleza, meditaciones y artículos con referencias. Elige un sonido y duración, inicia y el temporizador se sincroniza.</p>
        <div class="cta"><button class="btn-primary" onclick="document.getElementById('medit-block').scrollIntoView({behavior:'smooth'})">Iniciar Meditación</button></div>
      </div>
    </section>

    <div class="grid">
      <main>
        <!-- Meditación -->
        <section id="medit-block" class="card med-card" aria-labelledby="medit-title">
          <h3 id="medit-title">Meditación interactiva</h3>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <div class="selector-row">
              <label for="soundSelect" style="color:#bfeffd">Sonido</label>
              <select id="soundSelect" aria-label="Selecciona sonido">
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">Lluvia suave</option>
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">Bosque</option>
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3">Río</option>
              </select>
            </div>

            <div class="selector-row">
              <div>
                <button class="btn-primary" onclick="setTimer(300)">5 min</button>
                <button class="btn-primary" onclick="setTimer(600)">10 min</button>
                <button class="btn-primary" onclick="setTimer(900)">15 min</button>
              </div>
            </div>
          </div>

          <div style="margin-top:14px" class="center">
            <div id="medCircle" class="med-circle" role="button" tabindex="0">Click para<br>meditar</div>
            <div class="time-display" style="margin-top:10px">Tiempo: <span id="timeDisplay">00:00</span></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
            <button id="startBtn" class="btn-primary">Iniciar</button>
            <button id="stopBtn" class="btn-primary" style="background:transparent;border:1px solid rgba(255,255,255,0.06)">Detener</button>
            <label style="margin-left:8px;font-size:13px"><input id="audioOnlyToggle" type="checkbox"> Solo audio</label>
          </div>

          <div id="audioNotice" class="notice" style="display:none"></div>
          <audio id="natureAudio" preload="none" controls style="display:none"></audio>
        </section>

        <!-- Artículos -->
        <section class="card" style="margin-top:16px" id="art">
          <h3 style="margin-top:0">Artículos</h3>
          <div class="articles-grid" id="articlesGrid" role="list"></div>
        </section>

        <!-- Tarot -->
        <section id="tarot" class="card" style="margin-top:16px">
          <h3>Tarot — Toca el mazo</h3>
          <div id="tarotSection">
            <div id="mazo" title="Toca el mazo para sacar una carta" aria-label="Mazo de tarot">
              <div style="color:#fff;text-align:center;font-weight:700">MAZO</div>
            </div>
            <img id="cardReveal" alt="Carta revelada" />
            <div id="tarotText" aria-live="polite"></div>
            <div style="font-size:12px;color:#9fd8ea">La interpretación se obtiene automáticamente desde Wikipedia y se traduce si es necesario.</div>
          </div>
        </section>

        <!-- YouTube Música -->
        <section id="music" class="card" style="margin-top:16px">
          <h3>Recomendaciones / Playlists (YouTube)</h3>
          <div class="playlists">
            <iframe src="https://www.youtube.com/embed/videoseries?list=PL6FMHId50GbE14ydduaNffH9ZCwpIOKpS" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            <iframe src="https://www.youtube.com/embed/videoseries?list=PL6FMHId50GbE14ydduaNffH9ZCwpIOKpS" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            <iframe src="https://www.youtube.com/embed/videoseries?list=PL6FMHId50GbGGi06g4gMUzsfMNveEKNxQ" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
        </section>
      </main>

      <!-- Aside -->
      <aside>
        <div class="card">
          <h4 style="margin-top:0">Música del día</h4>
          <div id="dailyList" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>

        <div class="card" id="reg" style="margin-top:12px">
          <h4 style="margin-top:0">Registro / Frase mensual</h4>
          <form id="subForm">
            <input id="emailInput" type="email" placeholder="tu@correo.com" required style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#dff8ff">
            <div style="margin-top:10px"><button class="btn-primary" type="submit">Suscribirme</button></div>
          </form>
          <div id="subInfo" style="margin-top:12px;color:#bfeffd"></div>
        </div>

        <div class="card" id="don" style="margin-top:12px">
          <h4 style="margin-top:0">Donaciones</h4>
          <p style="margin:0 0 10px 0;color:#cfeef7">Si valoras este proyecto, apóyalo.</p>
          <a class="btn-primary" href="https://www.paypal.com/donate/?hosted_button_id=GW4XCFHYRTJQQ" target="_blank" rel="noopener">Donar con PayPal</a>
        </div>
      </aside>
    </div>

    <footer id="contact" style="margin-top:20px">
      <div style="color:#9fd8ea">Contacto: <a href="mailto:almacoralma@gmail.com">almacoralma@gmail.com</a></div>
    </footer>
  </div>

  <!-- floating synchronized timer -->
  <div id="floatingBtn" class="floating-btn" title="Arrástrame">
    <div id="floatingLabel">Meditación</div>
    <div id="floatingTime" style="font-size:13px;margin-top:6px">00:00</div>
  </div>

<script>
/* ----------------- Helpers ----------------- */
const $ = id => document.getElementById(id);

/* ---------- Timer & sync (page + floating) ---------- */
let timerSec = 300;            // seconds left
let timerInterval = null;

function pad(n){ return String(n).padStart(2,'0'); }

function updateDisplays(){
  const m = Math.floor(timerSec/60), s = timerSec%60;
  const text = `${pad(m)}:${pad(s)}`;
  const td = $('timeDisplay');
  if(td) td.textContent = text;
  $('floatingTime').textContent = text;
  // change color when finished
  if(timerSec <= 0){
    $('floatingBtn').classList.add('finished');
    const mc = $('medCircle');
    if(mc) mc.style.border = '4px solid rgba(255,107,107,0.85)';
  } else {
    $('floatingBtn').classList.remove('finished');
    const mc = $('medCircle');
    if(mc) mc.style.border = '0';
  }
}

function setTimer(sec){
  timerSec = sec;
  updateDisplays();
}

function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    if(timerSec > 0){
      timerSec--;
      updateDisplays();
    } else {
      clearInterval(timerInterval);
      timerInterval = null;
      updateDisplays();
      // optional: play bell / notify
    }
  }, 1000);
}

function stopTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  updateDisplays();
}

/* UI bindings */
const startBtn = $('startBtn');
const stopBtn = $('stopBtn');
if(startBtn) startBtn.addEventListener('click', ()=> {
  const audio = $('natureAudio');
  const sel = $('soundSelect')?.value;
  if(sel && audio){
    audio.src = sel;
    audio.play().catch(()=>{});
  }
  startTimer();
});
if(stopBtn) stopBtn.addEventListener('click', ()=> {
  const audio = $('natureAudio');
  if(audio) audio.pause();
  stopTimer();
});
const medCircle = $('medCircle');
if(medCircle) medCircle.addEventListener('click', ()=> {
  const audio = $('natureAudio');
  const sel = $('soundSelect')?.value;
  if(sel && audio){
    audio.src = sel;
    audio.play().catch(()=>{});
  }
  startTimer();
});

/* Sync floating: clicking floating starts/stops same timer */
const floatingBtn = $('floatingBtn');
if(floatingBtn){
  floatingBtn.addEventListener('click', (e)=>{
    if(isDragging) return;
    if(timerInterval) stopTimer();
    else startTimer();
  });
}

/* ---------- Drag for floating ---------- */
let isDragging=false, offsetX=0, offsetY=0;
const floating = $('floatingBtn');
if(floating){
  floating.addEventListener('mousedown', e => {
    isDragging = true;
    offsetX = e.clientX - floating.offsetLeft;
    offsetY = e.clientY - floating.offsetTop;
    e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if(!isDragging) return;
    floating.style.left = (e.clientX - offsetX) + 'px';
    floating.style.top = (e.clientY - offsetY) + 'px';
  });
  document.addEventListener('mouseup', () => { isDragging=false; });
  // touch
  floating.addEventListener('touchstart', e => {
    isDragging = true;
    const t = e.touches[0];
    offsetX = t.clientX - floating.offsetLeft;
    offsetY = t.clientY - floating.offsetTop;
  });
  document.addEventListener('touchmove', e => {
    if(!isDragging) return;
    const t = e.touches[0];
    floating.style.left = (t.clientX - offsetX) + 'px';
    floating.style.top = (t.clientY - offsetY) + 'px';
  });
  document.addEventListener('touchend', ()=> isDragging=false);
}

/* ---------- Articles (simple demo) ---------- */
const ARTICLES = [
  {source:'Wikipedia', title:'Meditation', extract:'Meditation is a practice where an individual uses a technique to train attention and awareness.' , url:'https://en.wikipedia.org/wiki/Meditation'},
  {source:'Local', title:'Rutina de gratitud', extract:'Pequeños ejercicios diarios para practicar la gratitud.', url:'#'},
  {source:'arXiv', title:'Mindfulness research', extract:'Resumen de artículos científicos sobre mindfulness.', url:'#'}
];

function renderArticles(items){
  const grid = $('articlesGrid');
  if(!grid) return;
  grid.innerHTML = '';
  items.forEach(a=>{
    const card = document.createElement('div');
    card.className = 'article-card';
    card.innerHTML = `<h3>${a.title}</h3><p>${a.extract}</p><div class="source">Fuente: ${a.source}</div>`;
    grid.appendChild(card);
  });
}

/* ---------- YouTube Daily list (simple rotation) ---------- */
const YT_POOL = [
  {title:'Relaxing Forest Sounds', videoId:'2OEL4P1Rz04'},
  {title:'Ocean Waves', videoId:'VudJ_3R8F7A'},
  {title:'Rain Sounds', videoId:'qMiwb7cR3pE'}
];

function loadDailyList(){
  const dl = $('dailyList');
  if(!dl) return;
  dl.innerHTML = '';
  YT_POOL.forEach(it=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center';
    const img = document.createElement('img'); img.src=`https://i.ytimg.com/vi/${it.videoId}/default.jpg`; img.style.width='56px'; img.style.height='40px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
    const title = document.createElement('div'); title.style.fontSize='13px'; title.textContent=it.title;
    const open = document.createElement('a'); open.href=`https://www.youtube.com/watch?v=${it.videoId}`; open.target='_blank'; open.textContent='Abrir'; open.className='btn-primary'; open.style.padding='6px'; open.style.fontSize='12px';
    row.appendChild(img); row.appendChild(title); row.appendChild(open);
    dl.appendChild(row);
  });
}

/* ---------- TAROT: deck & logic ---------- */
/*
 We'll use images hosted at:
 https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/00_the_fool.jpg
 and similar for major arcana.
 For each card we define:
  - img: url to image
  - wiki: probable page title in en Wikipedia (with "(tarot card)" suffix)
*/
const TAROT_DECK = [
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/00_the_fool.jpg', wiki_en:'The Fool (Tarot card)', wiki_es:'El Loco (cartas del Tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/01_the_magician.jpg', wiki_en:'The Magician (Tarot card)', wiki_es:'El Mago (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/02_the_high_priestess.jpg', wiki_en:'The High Priestess (Tarot card)', wiki_es:'La Sacerdotisa (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/03_the_empress.jpg', wiki_en:'The Empress (Tarot card)', wiki_es:'La Emperatriz (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/04_the_emperor.jpg', wiki_en:'The Emperor (Tarot card)', wiki_es:'El Emperador (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/05_the_hierophant.jpg', wiki_en:'The Hierophant (Tarot card)', wiki_es:'El Hierofante (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/06_the_lovers.jpg', wiki_en:'The Lovers (Tarot card)', wiki_es:'Los Enamorados (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/07_the_chariot.jpg', wiki_en:'The Chariot (Tarot card)', wiki_es:'El Carro (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/08_strength.jpg', wiki_en:'Strength (Tarot card)', wiki_es:'La Fuerza (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/09_the_hermit.jpg', wiki_en:'The Hermit (Tarot card)', wiki_es:'El Ermitaño (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/10_wheel_of_fortune.jpg', wiki_en:'Wheel of Fortune (Tarot card)', wiki_es:'La Rueda de la Fortuna (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/11_justice.jpg', wiki_en:'Justice (Tarot card)', wiki_es:'La Justicia (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/12_the_hanged_man.jpg', wiki_en:'The Hanged Man (Tarot card)', wiki_es:'El Colgado (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/13_death.jpg', wiki_en:'Death (Tarot card)', wiki_es:'La Muerte (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/14_temperance.jpg', wiki_en:'Temperance (Tarot card)', wiki_es:'La Templanza (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/15_the_devil.jpg', wiki_en:'The Devil (Tarot card)', wiki_es:'El Diablo (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/16_the_tower.jpg', wiki_en:'The Tower (Tarot card)', wiki_es:'La Torre (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/17_the_star.jpg', wiki_en:'The Star (Tarot card)', wiki_es:'La Estrella (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/18_the_moon.jpg', wiki_en:'The Moon (Tarot card)', wiki_es:'La Luna (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/19_the_sun.jpg', wiki_en:'The Sun (Tarot card)', wiki_es:'El Sol (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/20_judgement.jpg', wiki_en:'Judgement (Tarot card)', wiki_es:'El Juicio (cartas del tarot)'},
  {img: 'https://raw.githubusercontent.com/ekelen/tarot-api/master/images/rws_major/21_the_world.jpg', wiki_en:'The World (Tarot card)', wiki_es:'El Mundo (cartas del tarot)'}
];

const mazo = $('mazo');
const cardReveal = $('cardReveal');
const tarotText = $('tarotText');

function elegirCartaAleatoria(){
  const i = Math.floor(Math.random() * TAROT_DECK.length);
  return TAROT_DECK[i];
}

/* Try fetch Spanish summary, if not, fetch English and translate via MyMemory */
async function fetchWikiSummary(card){
  // first try Spanish
  const esTitle = card.wiki_es;
  const enTitle = card.wiki_en;
  try {
    // es.wikipedia REST summary
    const esUrl = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(esTitle)}`;
    const resEs = await fetch(esUrl);
    if(resEs.ok){
      const jsonEs = await resEs.json();
      if(jsonEs && jsonEs.extract) return {text: jsonEs.extract, source: jsonEs.content_urls?.desktop?.page || `https://es.wikipedia.org/wiki/${encodeURIComponent(esTitle)}`};
    }
  } catch(e){
    /* ignore and try English */
  }

  try {
    const enUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(enTitle)}`;
    const resEn = await fetch(enUrl);
    if(resEn.ok){
      const jsonEn = await resEn.json();
      const enText = (jsonEn && jsonEn.extract) ? jsonEn.extract : '';
      // translate via MyMemory
      if(enText){
        const tr = await translateTextMyMemory(enText, 'en', 'es');
        return {text: tr, source: jsonEn.content_urls?.desktop?.page || `https://en.wikipedia.org/wiki/${encodeURIComponent(enTitle)}`};
      }
    }
  } catch(e){
    console.error('Error fetching wiki:', e);
  }
  return {text: 'No se encontró una interpretación automática para esta carta.', source: ''};
}

/* MyMemory public API translation (free): good enough for short extracts */
async function translateTextMyMemory(text, from='en', to='es'){
  try {
    const url = 'https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text.slice(0,1000)) + `&langpair=${from}|${to}`;
    const r = await fetch(url);
    if(!r.ok) return text;
    const j = await r.json();
    if(j && j.responseData && j.responseData.translatedText) return j.responseData.translatedText;
    return text;
  } catch(e){
    console.error('translate error',e);
    return text;
  }
}

/* Reveal card on mazo click */
if(mazo){
  mazo.addEventListener('click', async ()=>{
    // animate flip (basic)
    mazo.style.transform = 'scale(0.96)';
    setTimeout(()=> mazo.style.transform = '',120);
    const carta = elegirCartaAleatoria();
    // show image
    cardReveal.src = carta.img;
    cardReveal.style.display = 'block';
    tarotText.textContent = 'Cargando interpretación...';
    try {
      const res = await fetchWikiSummary(carta);
      tarotText.innerHTML = `<strong>Interpretación:</strong><p style="margin:8px 0 0 0">${res.text}</p><div style="margin-top:8px;font-size:12px;color:#9fd8ea">Fuente: <a href="${res.source}" target="_blank" style="color:#bfeffd">${res.source}</a></div>`;
    } catch(e){
      tarotText.textContent = 'Error al obtener interpretación.';
    }
  });
}

/* ---------- Subscription form ---------- */
const subForm = $('subForm');
if(subForm) subForm.addEventListener('submit', e=>{
  e.preventDefault();
  $('subInfo').textContent = '¡Gracias! Te hemos suscrito (demo)';
  $('emailInput').value = '';
});

/* ---------- Init content ---------- */
function init(){
  renderArticles(ARTICLES);
  loadDailyList();
  updateDisplays();
}
init();

/* ---------- Utility: prevent CSP issues with iframes (nothing special) ---------- */
/* End of script */
</script>
</body>
</html>