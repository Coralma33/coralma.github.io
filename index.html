<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CorAlma — Encuentra tu calma</title>
<meta name="description" content="Meditaciones, sonidos y artículos dinámicos. Sonidos con fallback entre servidores." />
<style>
:root{
  --bg1:#020414; --bg2:#041428;
  --accent1:#6ec6d9; --accent2:#8a6cff;
  --glass: rgba(255,255,255,0.04);
  --muted:#9fd8ea; --text:#e6f9ff;
  --finished:#ff6b6b;
  --btn-orange: #ff8a3d;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; -webkit-font-smoothing:antialiased}
body{
  color:var(--text);
  background:
    radial-gradient(circle at 10% 10%, rgba(138,108,255,0.06), transparent 6%),
    radial-gradient(circle at 90% 70%, rgba(110,198,217,0.04), transparent 10%),
    linear-gradient(180deg,var(--bg1), var(--bg2));
  min-height:100vh;
}
.container{max-width:1180px;margin:24px auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021018}
nav{display:flex;gap:10px;align-items:center}
nav a{color:#cfeffb;text-decoration:none;padding:8px 10px;border-radius:9px}
nav a:hover{background:var(--glass)}

/* hero */
.hero{margin-top:14px;border-radius:14px;padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));display:flex;gap:20px;align-items:center;position:relative;overflow:hidden}
.hero-left{flex:1}
.cta .btn-primary{margin-top:12px}

/* layout */
.grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-top:22px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:16px;border-radius:12px}
.med-card{padding:18px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);box-shadow:0 10px 40px rgba(15,30,50,0.45)}
.center{display:flex;flex-direction:column;align-items:center;gap:12px}
.selector-row{display:flex;gap:10px;align-items:center;width:100%;justify-content:center;flex-wrap:wrap}
select,input,button{background:transparent;color:#dff8ff;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
.btn-primary{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021018;padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
.btn-orange{background:linear-gradient(90deg,var(--btn-orange),#ffb081);color:#021018;padding:8px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}

/* timer / circle */
.med-circle{width:160px;height:160px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#021018;font-weight:700;font-size:16px;cursor:pointer;box-shadow:0 12px 40px rgba(60,80,120,0.18);transition:transform .12s,border-color .2s}
.med-circle:hover{transform:scale(1.06) translateZ(0)}
.time-display{font-weight:700;}

/* pulso sutil del círculo mientras está en reposo */
@keyframes breathe {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}
.med-circle.idle { animation: breathe 6s ease-in-out infinite; }

/* articles */
.articles-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px;max-height:480px;overflow:auto;padding-right:6px}
.article-card{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);text-align:left}
.article-card h3{margin:0 0 6px 0;font-size:16px}
.article-card p{margin:0;color:#cfeef7;font-size:14px}
.article-card .source{font-size:12px;color:#9fd8ea;margin-top:6px}
.read-btn{margin-top:8px;padding:6px 8px;border-radius:8px;border:0;background:rgba(255,255,255,0.04);color:#dff8ff;cursor:pointer}

/* youtube/recommendations */
.youtube-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:12px}
.youtube-thumb{background:#0b1620;border-radius:8px;overflow:hidden;cursor:pointer;position:relative;padding-bottom:6px}
.youtube-thumb img{width:100%;display:block;height:88px;object-fit:cover}
.youtube-thumb .yt-title{font-size:12px;padding:6px;color:#eaf9ff}
.youtube-controls{display:flex;gap:6px;justify-content:center;padding-top:6px}

/* yt player container */
#ytPlayerContainer{margin-top:12px;border-radius:10px;overflow:hidden;background:rgba(0,0,0,0.35);padding:8px;display:none}
#ytPlayer{width:100%;height:180px;border:0;border-radius:8px}

/* floating draggable timer */
.floating-btn{position:fixed;right:20px;bottom:20px;width:120px;height:120px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#021018;font-weight:700;cursor:move;z-index:2000;box-shadow:0 12px 40px rgba(60,80,120,0.18);transition:transform .12s,background .25s}
.floating-btn.finished{background:var(--finished); color:#fff;}

/* mini in-page player */
.mini-player{
  position:fixed; right:160px; bottom:100px; width:320px; height:190px;
  background:#021018; border-radius:10px; z-index:2500; box-shadow:0 12px 40px rgba(0,0,0,0.6); display:none; overflow:hidden;
  color:var(--text);
}
.mini-player.small{width:240px;height:120px}
.mini-player .mp-header{display:flex;align-items:center;justify-content:space-between;padding:8px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06))}
.mini-player .mp-title{font-size:13px;flex:1;padding-left:6px}
.mini-player .mp-controls{display:flex;gap:6px}
.mini-player .mp-body{padding:6px}

/* social bar (colored icons) */
.social-bar{
  position:fixed;
  top:50%;
  right:12px;
  transform:translateY(-50%);
  display:flex;
  flex-direction:column;
  gap:12px;
  z-index:3000;
}
.social-bar a{
  width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:transparent;
}
.social-bar img{width:34px;height:34px;display:block;}

/* tweak TikTok icon color so it contraste bien con fondo (solo se aplica al PNG existente) */
.social-bar a.tiktok img{
  filter: invert(62%) sepia(36%) saturate(400%) hue-rotate(135deg) brightness(1) contrast(1);
  drop-shadow: 0 2px 6px rgba(0,0,0,0.6);
}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,6,12,0.65);display:none;align-items:center;justify-content:center;padding:18px;z-index:4000}
.modal-back.on{display:flex}
.modal{background:linear-gradient(180deg,#031425,#041a2a);border-radius:12px;padding:18px;max-width:920px;width:100%;max-height:90vh;overflow:auto}
.modal h2{margin-top:0}
.modal .refs{margin-top:12px;color:#bfeffd}

/* small helpers */
.notice{font-size:13px;color:#ffd7a8;background:rgba(0,0,0,0.15);padding:8px;border-radius:8px;margin-top:8px}
@media(max-width:980px){.grid{grid-template-columns:1fr}.articles-grid{grid-template-columns:1fr}.mini-player{right:12px;left:12px;width:auto}}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">CA</div>
        <div>
          <h1>CorAlma</h1>
          <div style="font-size:12px;color:#bfeffd">Encuentra tu calma en el universo interior</div>
        </div>
      </div>
      <nav>
        <a href="#">Inicio</a>
        <a href="#medit-block">Meditación</a>
        <a href="#art">Artículos</a>
        <a href="#contact">Contacto</a>
      </nav>
    </header>

    <section class="hero" aria-labelledby="hero-title">
      <div class="hero-left">
        <h2 id="hero-title">Calma y presencia — prácticas basadas en ciencia y tradición</h2>
        <p>Sonidos de naturaleza, meditaciones y artículos con referencias. Elige un sonido y duración, inicia y el temporizador se sincroniza con el botón flotante.</p>
        <div class="cta"><button class="btn-primary" onclick="document.getElementById('medit-block').scrollIntoView({behavior:'smooth'})">Iniciar Meditación</button></div>
      </div>
    </section>

    <div class="grid">
      <main>
        <!-- Meditación -->
        <section id="medit-block" class="card med-card" aria-labelledby="medit-title">
          <h3 id="medit-title">Meditación interactiva</h3>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <div class="selector-row">
              <label for="soundSelect" style="color:#bfeffd">Sonido</label>
              <select id="soundSelect" aria-label="Selecciona sonido">
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3">Lluvia suave</option>
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3">Bosque</option>
                <option value="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3">Río</option>
              </select>
            </div>

            <div class="selector-row">
              <div>
                <button class="btn-primary" onclick="setTimer(300)">5 min</button>
                <button class="btn-primary" onclick="setTimer(600)">10 min</button>
                <button class="btn-primary" onclick="setTimer(900)">15 min</button>
              </div>
            </div>
          </div>

          <div style="margin-top:14px" class="center">
            <div id="medCircle" class="med-circle idle" role="button" tabindex="0">Click para<br>meditar</div>
            <div class="time-display" style="margin-top:10px">Tiempo: <span id="timeDisplay">00:00</span></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
            <button id="startBtn" class="btn-primary">Iniciar</button>
            <!-- Botón naranja adicional justo al lado -->
            <button id="orangeBtn" class="btn-orange" title="Acción rápida">▶ Ambiente</button>
            <button id="stopBtn" class="btn-primary" style="background:transparent;border:1px solid rgba(255,255,255,0.06)">Detener</button>
            <label style="margin-left:8px;font-size:13px"><input id="audioOnlyToggle" type="checkbox"> Solo audio (ocultar video)</label>
          </div>

          <div id="audioNotice" class="notice" style="display:none"></div>
          <audio id="natureAudio" preload="none" controls style="display:none"></audio>
        </section>

        <!-- Artículos -->
        <section class="card" style="margin-top:16px" id="art">
          <h3 style="margin-top:0">Artículos</h3>
          <div class="articles-grid" id="articlesGrid" role="list"></div>
        </section>

        <!-- YouTube buscador y reproductor -->
        <section class="card" style="margin-top:16px">
          <h3>Recomendaciones / Buscador (YouTube)</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="ytKeyword" type="text" placeholder="Palabra clave (ej. forest, rain)..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#dff8ff">
            <button class="btn-primary" onclick="doSearch()">Buscar</button>
            <button class="btn-primary" onclick="loadDailyRecs()">Rec. del día</button>
          </div>

          <div class="youtube-grid" id="youtubeGrid" aria-live="polite" aria-atomic="true"></div>

          <div id="ytPlayerContainer">
            <iframe id="ytPlayer" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
              <button class="btn-primary" onclick="stopYT()">Detener</button>
              <span id="ytNow" style="margin-left:8px;font-size:13px;color:#bfeffd"></span>
            </div>
          </div>
        </section>
      </main>

      <aside>
        <div class="side-block">
          <div class="card">
            <h4 style="margin-top:0">Música del día</h4>
            <div id="dailyList" style="display:flex;flex-direction:column;gap:8px"></div>
          </div>

          <div class="card" id="reg">
            <h4 style="margin-top:0">Registro / Frase mensual</h4>
            <form id="subForm">
              <input id="emailInput" type="email" placeholder="tu@correo.com" required style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#dff8ff">
              <div style="margin-top:10px"><button class="btn-primary" type="submit">Suscribirme</button></div>
            </form>
            <div id="subInfo" style="margin-top:12px;color:#bfeffd"></div>
          </div>

          <div class="card" id="don">
            <h4 style="margin-top:0">Donaciones</h4>
            <p style="margin:0 0 10px 0;color:#cfeef7">Si valoras este proyecto, apóyalo.</p>
            <!-- PayPal integrado -->
            <form action="https://www.paypal.com/donate" method="post" target="_blank" style="display:inline-block">
              <input type="hidden" name="hosted_button_id" value="GW4XCFHYRTJQQ" />
              <button class="btn-primary" type="submit">Donar con PayPal</button>
            </form>
          </div>
        </div>
      </aside>
    </div>

    <footer id="contact" style="margin-top:20px">
      <div style="color:#9fd8ea">Contacto: <a href="mailto:almacoralma@gmail.com">almacoralma@gmail.com</a></div>
    </footer>
  </div>

  <!-- floating synchronized timer -->
  <div id="floatingBtn" class="floating-btn" title="Arrástrame">
    <div id="floatingLabel">Meditación</div>
    <div id="floatingTime" style="font-size:13px;margin-top:6px">00:00</div>
  </div>

  <!-- mini in-page player (draggable/resizable/closeable) -->
  <div id="miniPlayer" class="mini-player" role="dialog" aria-hidden="true">
    <div class="mp-header" id="miniHeader">
      <div class="mp-title" id="miniTitle">Reproductor</div>
      <div class="mp-controls">
        <button class="btn-primary" id="miniPlay">▶</button>
        <button class="btn-primary" id="miniPause">⏸</button>
        <button class="btn-primary" id="miniStop">⏹</button>
        <button class="btn-primary" id="miniToggleSize">⇱</button>
        <button class="btn-primary" id="miniClose">✕</button>
      </div>
    </div>
    <div class="mp-body" id="miniBody">
      <div id="yt-player"></div>
      <div style="margin-top:8px;font-size:13px;color:#bfeffd"><a id="miniOpen" href="#" target="_blank" style="color:#bfeffd">Abrir en YouTube</a></div>
    </div>
  </div>

  <!-- social bar with colored icons -->
  <div class="social-bar" aria-hidden="false">
    <a href="https://www.instagram.com/effectno33?igsh=MjAycWE4dTFsbXpw" target="_blank" title="Instagram" rel="noopener">
      <img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram">
    </a>
    <a class="tiktok" href="https://www.tiktok.com/@effect.33?_t=ZS-8zp1etEPK4L&_r=1" target="_blank" title="TikTok" rel="noopener">
      <img src="https://cdn-icons-png.flaticon.com/512/3046/3046122.png" alt="TikTok">
    </a>
    <a href="https://youtube.com/@effect.no33?si=3NhJg_TLLsG51Z8i" target="_blank" title="YouTube" rel="noopener">
      <img src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" alt="YouTube">
    </a>
  </div>

  <!-- modal for articles -->
  <div id="modalBack" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle"></h2>
      <div id="modalBody" style="color:#dffcff;line-height:1.6"></div>
      <div id="modalRefs" class="refs"></div>
      <div style="text-align:right;margin-top:12px">
        <button id="closeModal" class="btn-primary" style="background:transparent;color:#bfeffd;border:1px solid rgba(255,255,255,0.06)">Cerrar</button>
      </div>
    </div>
  </div>

<script>
/* ----------------- Helpers ----------------- */
const $ = id => document.getElementById(id);

/* ---------- Timer & sync (page + floating) ---------- */
let timerSec = 300;            // default seconds
let timerTotal = timerSec;    // total seconds (se actualiza cuando el usuario cambia duración)
let timerInterval = null;
let isDragging = false;

function pad(n){ return String(n).padStart(2,'0'); }

function updateDisplays(){
  const m = Math.floor(timerSec/60), s = timerSec%60;
  const text = `${pad(m)}:${pad(s)}`;
  const td = $('timeDisplay');
  if(td) td.textContent = text;
  $('floatingTime').textContent = text;

  // --- escala proporcional del círculo y botón flotante ---
  const total = Math.max(1, timerTotal || 300);
  const proportion = Math.max(0, timerSec / total); // 1 -> 0
  const minScaleCircle = 0.18;
  const minScaleFloating = 0.18;
  const scale = Math.max(minScaleCircle, proportion);
  const fScale = Math.max(minScaleFloating, proportion);

  const med = $('medCircle');
  if(med) med.style.transform = `scale(${scale})`;
  const fb = $('floatingBtn');
  if(fb) fb.style.transform = `scale(${fScale})`;

  // change color when finished
  if(timerSec <= 0){
    $('floatingBtn').classList.add('finished');
    if(med) med.style.border = '4px solid rgba(255,107,107,0.85)';
    if(med) med.style.transform = 'scale(0)';
    if(fb) fb.style.transform = 'scale(0.12)';
  } else {
    $('floatingBtn').classList.remove('finished');
    if(med) med.style.border = '0';
  }
}

function setTimer(sec){
  timerSec = sec;
  timerTotal = sec;
  updateDisplays();
}

function startTimer(){
  if(!timerTotal || timerTotal <= 0) timerTotal = timerSec || 300;
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    if(timerSec > 0){
      timerSec--;
      updateDisplays();
    } else {
      clearInterval(timerInterval);
      timerInterval = null;
      updateDisplays();
      // you could add an end sound here if desired
    }
  }, 1000);
}

function stopTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  updateDisplays();
}

/* UI bindings */
$('startBtn').addEventListener('click', ()=> {
  const audio = $('natureAudio');
  const sel = $('soundSelect').value;
  if(sel){
    audio.src = sel;
    audio.play().catch(()=>{});
    $('audioNotice').style.display='block';
    $('audioNotice').innerText='Reproduciendo sonido: '+(document.querySelector('#soundSelect option:checked').text || '');
  }
  startTimer();
  // show mini-player with first daily rec for ambience (optional)
  const recs = dailyRotation(YT_POOL,1);
  if(recs && recs[0]) playPlaylistIndex(currentPlaylistIndex || 0);
});
$('stopBtn').addEventListener('click', ()=> {
  $('natureAudio').pause();
  stopTimer();
  $('audioNotice').style.display='none';
});
$('medCircle').addEventListener('click', ()=> {
  const audio = $('natureAudio');
  const sel = $('soundSelect').value;
  if(sel){
    audio.src = sel;
    audio.play().catch(()=>{});
    $('audioNotice').style.display='block';
    $('audioNotice').innerText='Reproduciendo sonido: '+(document.querySelector('#soundSelect option:checked').text || '');
  }
  startTimer();
});

/* orange quick button plays today's ambient audio */
$('orangeBtn').addEventListener('click', ()=>{
  const idx = getDailyMusicIndex();
  const item = MUSIC_DAILY[idx];
  if(item){
    $('natureAudio').src = item.url;
    $('natureAudio').play().catch(()=>{});
    $('audioNotice').style.display='block';
    $('audioNotice').innerText = 'Reproduciendo: ' + item.name;
    // sync select if name matches
    syncSelectToName(item.name);
  }
});

/* Sync floating: clicking floating starts/stops same timer */
$('floatingBtn').addEventListener('click', (e)=>{
  if(isDragging) return;
  if(timerInterval) stopTimer();
  else {
    const audio = $('natureAudio');
    const sel = $('soundSelect').value;
    if(sel){
      audio.src = sel;
      audio.play().catch(()=>{});
      $('audioNotice').style.display='block';
    }
    startTimer();
  }
});

/* ---------- Drag for floating ---------- */
const floating = $('floatingBtn');
floating.addEventListener('mousedown', e => {
  isDragging = true;
  offsetX = e.clientX - floating.offsetLeft;
  offsetY = e.clientY - floating.offsetTop;
  e.preventDefault();
});
document.addEventListener('mousemove', e => {
  if(!isDragging) return;
  floating.style.left = (e.clientX - offsetX) + 'px';
  floating.style.top = (e.clientY - offsetY) + 'px';
});
document.addEventListener('mouseup', () => { isDragging=false; });
/* touch */
floating.addEventListener('touchstart', e => {
  isDragging = true;
  const t = e.touches[0];
  offsetX = t.clientX - floating.offsetLeft;
  offsetY = t.clientY - floating.offsetTop;
});
document.addEventListener('touchmove', e => {
  if(!isDragging) return;
  const t = e.touches[0];
  floating.style.left = (t.clientX - offsetX) + 'px';
  floating.style.top = (t.clientY - offsetY) + 'px';
});
document.addEventListener('touchend', ()=> isDragging=false);

/* ---------- Articles (rotate every 3 days) ---------- */
const ARTICLES_KEY = 'coralma_articles_v3';
const ARTICLES_DATE_KEY = 'coralma_articles_date_v3';
const ROTATE_MS = 3 * 24 * 60 * 60 * 1000;
const MAX_ARTICLES = 30;

/* ... (fetchWikipediaTopics, fetchRedditPosts, fetchArxiv, loadArticles, renderArticles) ...
   -- identical to your previous implementation to preserve behavior -- */
async function fetchWikipediaTopics(topics = ['Meditation','Mindfulness','Neuroscience','Gratitude','Relaxation']) {
  const results = [];
  for(const t of topics){
    try{
      const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(t)}`;
      const r = await fetch(url);
      if(!r.ok) continue;
      const json = await r.json();
      results.push({
        source: 'Wikipedia',
        title: json.title || t,
        extract: json.extract || '',
        url: (json.content_urls && json.content_urls.desktop && json.content_urls.desktop.page) || `https://en.wikipedia.org/wiki/${encodeURIComponent(t)}`
      });
    }catch(e){}
  }
  return results;
}
async function fetchRedditPosts(subs=['Meditation','Philosophy']){
  const results = [];
  for(const s of subs){
    try{
      const url = `https://api.allorigins.win/raw?url=${encodeURIComponent('https://www.reddit.com/r/'+s+'/hot.json?limit=6')}`;
      const r = await fetch(url);
      if(!r.ok) continue;
      const json = await r.json();
      if(json && json.data && Array.isArray(json.data.children)){
        json.data.children.forEach(ch=>{
          const d = ch.data;
          results.push({
            source: `r/${s}`,
            title: d.title || 'Reddit post',
            extract: (d.selftext && d.selftext.substring(0,300)) || '',
            url: `https://reddit.com${d.permalink}`
          });
        });
      }
    }catch(e){}
  }
  return results;
}
async function fetchArxiv(query='mindfulness OR meditation', max=12){
  try{
    const api = `https://export.arxiv.org/api/query?search_query=all:${encodeURIComponent(query)}&start=0&max_results=${max}`;
    const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(api)}`;
    const r = await fetch(proxy);
    if(!r.ok) return [];
    const text = await r.text();
    const doc = new DOMParser().parseFromString(text,'application/xml');
    const entries = Array.from(doc.querySelectorAll('entry'));
    return entries.map(e=>{
      return {
        source: 'arXiv',
        title: (e.querySelector('title') && e.querySelector('title').textContent.trim()) || 'arXiv article',
        extract: (e.querySelector('summary') && e.querySelector('summary').textContent.trim().replace(/\s+/g,' ').substring(0,300)) || '',
        url: (e.querySelector('id') && e.querySelector('id').textContent) || ''
      };
    });
  }catch(e){ return []; }
}
async function loadArticles(){
  try{
    const last = localStorage.getItem(ARTICLES_DATE_KEY);
    const now = Date.now();
    if(!last || (now - Number(last)) > ROTATE_MS || !localStorage.getItem(ARTICLES_KEY)){
      const [wiki, reddit, arxiv] = await Promise.all([fetchWikipediaTopics(), fetchRedditPosts(), fetchArxiv()]);
      const combined = [...wiki, ...reddit, ...arxiv];
      const items = combined.length ? combined.slice(0,MAX_ARTICLES) : Array.from({length:MAX_ARTICLES}).map((_,i)=>({
        source: 'Local',
        title: `Artículo de ejemplo ${i+1}`,
        extract: `Este es un resumen de ejemplo para el artículo ${i+1}.`,
        url: '#'
      }));
      localStorage.setItem(ARTICLES_KEY, JSON.stringify(items));
      localStorage.setItem(ARTICLES_DATE_KEY, String(now));
      renderArticles(items);
    } else {
      const saved = JSON.parse(localStorage.getItem(ARTICLES_KEY) || '[]');
      renderArticles(saved);
    }
  }catch(e){
    const items = Array.from({length:10}).map((_,i)=>({source:'Local',title:`Artículo ${i+1}`,extract:`Resumen ${i+1}`,url:'#'}));
    renderArticles(items);
  }
}
function renderArticles(items){
  const grid = $('articlesGrid');
  grid.innerHTML = '';
  items.forEach((a, idx)=>{
    const card = document.createElement('div');
    card.className = 'article-card';
    const title = a.title || 'Sin título';
    const extract = (a.extract || '').replace(/\n/g,' ').trim();
    const shortTitle = title.length > 60 ? title.slice(0,57)+'...' : title;
    const shortExtract = extract.length > 220 ? extract.slice(0,217)+'...' : extract;
    const source = a.source || 'Fuente';
    const url = a.url || '#';
    card.innerHTML = `
      <h3>${shortTitle}</h3>
      <p>${shortExtract}</p>
      <div class="source">Fuente: ${source}</div>
      <div style="margin-top:8px"><button class="read-btn" data-idx="${idx}">Leer más</button></div>
    `;
    card.querySelector('.read-btn').addEventListener('click', ()=>{
      openArticleModal(a);
    });
    grid.appendChild(card);
  });
}

/* ---------- Article modal ---------- */
const modalBack = $('modalBack');
const modalTitle = $('modalTitle');
const modalBody = $('modalBody');
const modalRefs = $('modalRefs');
$('closeModal').addEventListener('click', ()=> modalBack.classList.remove('on'));
function openArticleModal(a){
  modalTitle.textContent = a.title || 'Artículo';
  modalBody.textContent = a.extract || 'No hay resumen disponible.';
  modalRefs.innerHTML = `<div style="margin-top:8px"><a href="${a.url}" target="_blank" style="color:#bfeffd">Abrir fuente en nueva pestaña</a></div>`;
  modalBack.classList.add('on');
}

/* ---------- YouTube playlists & rotation ---------- */

/*
  IMPORTANT: Replace the PLAYLISTS array entries with real YouTube PLAYLIST IDs.
  The code is ready to handle 20 playlists. For each playlist we keep:
    { title: 'friendly name', playlistId: 'PLxxxx...' }
  If you want, dime y busco e inyecto 20 playlists reales. Por ahora hay placeholders.
*/

const PLAYLISTS = [
  /* 20 placeholders — reemplázalos por IDs reales (ej: 'PLxxx') */
  {title: 'Relax – Forest mix', playlistId: 'PL_PLACEHOLDER_1'},
  {title: 'Ocean Waves Playlist', playlistId: 'PL_PLACEHOLDER_2'},
  {title: 'Rain & Nature', playlistId: 'PL_PLACEHOLDER_3'},
  {title: 'Meditation Music 432Hz', playlistId: 'PL_PLACEHOLDER_4'},
  {title: 'Binaural Relaxation', playlistId: 'PL_PLACEHOLDER_5'},
  {title: 'Deep Sleep Sounds', playlistId: 'PL_PLACEHOLDER_6'},
  {title: 'Study Ambient', playlistId: 'PL_PLACEHOLDER_7'},
  {title: 'Nature Streams', playlistId: 'PL_PLACEHOLDER_8'},
  {title: 'Tibetan Bowls', playlistId: 'PL_PLACEHOLDER_9'},
  {title: 'Calm Piano', playlistId: 'PL_PLACEHOLDER_10'},
  {title: 'Chillout Nature', playlistId: 'PL_PLACEHOLDER_11'},
  {title: 'White Noise Long', playlistId: 'PL_PLACEHOLDER_12'},
  {title: 'Ambient Night', playlistId: 'PL_PLACEHOLDER_13'},
  {title: 'Ghz / Frequencies', playlistId: 'PL_PLACEHOLDER_14'},
  {title: 'Forest Birds', playlistId: 'PL_PLACEHOLDER_15'},
  {title: 'Waterfall Soothing', playlistId: 'PL_PLACEHOLDER_16'},
  {title: 'Gentle Wind', playlistId: 'PL_PLACEHOLDER_17'},
  {title: 'Cave Drips', playlistId: 'PL_PLACEHOLDER_18'},
  {title: 'Ocean Deep', playlistId: 'PL_PLACEHOLDER_19'},
  {title: 'Guided Breathing', playlistId: 'PL_PLACEHOLDER_20'}
];

/* small pool of single videos used to show thumbnails in sidebar / grid;
   kept small so UI is responsive; this pool is independent from playlists */
const YT_POOL = [
  {title:'Relaxing Forest Sounds', videoId:'2OEL4P1Rz04'},
  {title:'Ocean Waves for Meditation', videoId:'VudJ_3R8F7A'},
  {title:'Rain Sounds Nature', videoId:'qMiwb7cR3pE'},
  {title:'Mountain Stream', videoId:'5qap5aO4i9A'},
  {title:'Jungle Ambience', videoId:'OdIJ2x3nxzQ'},
  {title:'Calm Night Crickets', videoId:'1ZYbU82GVz4'},
  {title:'Deep Ocean Waves', videoId:'ABdFQvT2gBI'},
  {title:'Waterfall Relaxation', videoId:'W0s0cKZqjSE'}
];

/* dailyRotation generalized: keeps the same 6 recommendation count (no te quité el 6) */
function dailyRotation(pool, count=6){
  const day = new Date().toISOString().slice(0,10).replace(/-/g,''); // YYYYMMDD
  let seed = 0;
  for(const ch of day) seed = (seed + Number(ch||0)) % 100000;
  const offset = seed % pool.length;
  const arr = [];
  for(let i=0;i<count;i++){
    arr.push(pool[(offset + i) % pool.length]);
  }
  return arr;
}

/* ---------- Render YT grid (video thumbnails) ---------- */
function renderYTGrid(items){
  const grid = $('youtubeGrid');
  grid.innerHTML = '';
  items.forEach(it=>{
    const thumb = document.createElement('div');
    thumb.className = 'youtube-thumb';
    const img = document.createElement('img');
    img.src = `https://i.ytimg.com/vi/${it.videoId}/hqdefault.jpg`;
    img.alt = it.title;
    const title = document.createElement('div');
    title.className = 'yt-title';
    title.textContent = it.title;
    const controls = document.createElement('div');
    controls.className = 'youtube-controls';
    const playBtn = document.createElement('button');
    playBtn.className='btn-primary';
    playBtn.textContent = '▶️';
    playBtn.addEventListener('click', ()=> playSingleVideo(it.videoId, it.title));
    const openBtn = document.createElement('button');
    openBtn.className='btn-primary';
    openBtn.textContent = 'Abrir';
    openBtn.addEventListener('click', ()=> window.open(`https://www.youtube.com/watch?v=${it.videoId}`,'_blank'));
    controls.appendChild(playBtn);
    controls.appendChild(openBtn);

    thumb.appendChild(img);
    thumb.appendChild(title);
    thumb.appendChild(controls);
    grid.appendChild(thumb);
  });
}

/* ---------- DAILY MUSIC (5 canciones) ---------- */
const MUSIC_DAILY = [
  {name: 'Lluvia', url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"},
  {name: 'Bosque', url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"},
  {name: 'Río', url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3"},
  {name: 'Montaña', url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3"},
  {name: 'Desierto', url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3"}
];

function getDailyMusicIndex(){
  return Math.floor(Date.now()/(1000*60*60*24)) % MUSIC_DAILY.length;
}

function loadDailyMusic(){
  const idx = getDailyMusicIndex();
  const item = MUSIC_DAILY[idx];
  const audio = $('natureAudio');
  // we don't autoplay on load per browser policies; we set source
  audio.src = item.url;

  // render lista lateral con las 5 canciones (la de hoy marcada)
  const dl = $('dailyList');
  if(dl){
    dl.innerHTML = '';
    MUSIC_DAILY.forEach((it, i) => {
      const div = document.createElement('div');
      div.style.display='flex'; div.style.gap='8px'; div.style.alignItems='center';
      const img = document.createElement('img');
      img.src = `https://i.ytimg.com/vi/${YT_POOL[i % YT_POOL.length].videoId}/default.jpg`;
      img.style.width='56px'; img.style.height='40px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
      const title = document.createElement('div');
      title.style.fontSize='13px';
      title.textContent = (i === idx) ? `${it.name} (hoy)` : it.name;
      const play = document.createElement('button');
      play.className='btn-primary';
      play.textContent='▶️';
      play.addEventListener('click', ()=> {
        audio.src = it.url;
        audio.play().catch(()=>{});
        syncSelectToName(it.name);
        $('audioNotice').style.display='block';
        $('audioNotice').innerText='Reproduciendo sonido: '+it.name;
      });
      div.appendChild(img); div.appendChild(title); div.appendChild(play);
      dl.appendChild(div);
    });
  }

  // sincronizar el select si el nombre de la canción del día coincide con alguna opción
  syncSelectToName(item.name);
}

/* helper: try to match a select option by name substring */
function syncSelectToName(name){
  const opts = document.querySelectorAll('#soundSelect option');
  opts.forEach(o=>{
    if(o.textContent.toLowerCase().includes(name.toLowerCase())){
      o.selected = true;
    }
  });
}

/* ---------- YouTube IFrame API player for playlists ---------- */
let YT_API_loaded = false;
let playlistPlayer = null;       // YT.Player instance for playlist playback
let currentPlaylistIndex = 0;    // index into PLAYLISTS
let currentPlaylistItemIndex = 0; // item index inside current playlist (tracked via state)
let isUsingPlaylistPlayer = false;

function loadYouTubeAPI(){
  if(window.YT && window.YT.Player){ YT_API_loaded = true; return; }
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(tag);
  window.onYouTubeIframeAPIReady = () => { YT_API_loaded = true; };
}
loadYouTubeAPI();

/* create or update the playlist player (uses playlist parameter) */
function playPlaylistIndex(index){
  if(!PLAYLISTS || PLAYLISTS.length === 0) return;
  currentPlaylistIndex = index % PLAYLISTS.length;
  const pl = PLAYLISTS[currentPlaylistIndex];
  const playlistId = pl.playlistId;
  if(!playlistId || playlistId.startsWith('PL_PLACEHOLDER')) {
    // placeholder: show notice and do nothing
    $('ytNow').textContent = `Playlist (${pl.title}) — pendiente ID real`;
    showMiniPlayerFallbackMessage(pl.title);
    return;
  }
  showMiniPlayer(pl.title);
  if(YT_API_loaded){
    const container = 'yt-player';
    // initialize player if missing
    if(!playlistPlayer){
      playlistPlayer = new YT.Player(container, {
        height: '160',
        width: '300',
        playerVars: { autoplay: 1, controls: 1, modestbranding: 1, rel: 0, listType: 'playlist', list: playlistId },
        events: {
          onReady: (e) => {
            e.target.playVideo && e.target.playVideo();
            isUsingPlaylistPlayer = true;
            $('ytNow').textContent = `Reproduciendo playlist: ${pl.title}`;
          },
          onStateChange: onPlaylistStateChange
        }
      });
    } else {
      // load or cue the playlist
      try {
        playlistPlayer.loadPlaylist && playlistPlayer.loadPlaylist({list: playlistId, listType:'playlist', index:0, suggestedQuality:'default'});
        isUsingPlaylistPlayer = true;
        $('ytNow').textContent = `Reproduciendo playlist: ${pl.title}`;
      } catch(e){
        // fallback: destroy and recreate
        playlistPlayer.destroy && playlistPlayer.destroy();
        playlistPlayer = null;
        playPlaylistIndex(currentPlaylistIndex);
      }
    }
  } else {
    // fallback embed
    const body = $('miniBody');
    body.querySelector('#yt-player') && (body.querySelector('#yt-player').innerHTML = `<iframe width="100%" height="140" src="https://www.youtube.com/embed?listType=playlist&list=${playlistId}&autoplay=1&rel=0&modestbranding=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`);
    $('ytNow').textContent = `Reproduciendo playlist: ${pl.title}`;
    document.getElementById('miniPlayer').style.display = 'block';
  }
}

/* when playlist player fires state changes: detect end of playlist to rotate to next */
function onPlaylistStateChange(event){
  // event.data values: -1 unstarted, 0 ended, 1 playing, 2 paused, 3 buffering, 5 video cued
  // To detect end of playlist reliably, check when state==0 and playlist index is last.
  try {
    const player = playlistPlayer;
    if(!player || !player.getPlaylist) return;
    const state = event.data;
    if(state === YT.PlayerState.PLAYING){
      // update now text
      const info = PLAYLISTS[currentPlaylistIndex];
      if(info) $('ytNow').textContent = `Reproduciendo playlist: ${info.title}`;
    }
    if(state === YT.PlayerState.ENDED || state === 0){
      // check current index vs playlist length
      const idx = player.getPlaylistIndex && player.getPlaylistIndex();
      const length = player.getPlaylist && player.getPlaylist().length;
      // if it's the last item, advance to next playlist
      if(typeof idx !== 'undefined' && typeof length !== 'undefined'){
        if(idx >= (length-1)){
          // advance playlist
          advanceToNextPlaylist();
        }
      } else {
        // conservative fallback: after ended, advance
        advanceToNextPlaylist();
      }
    }
  } catch(e){
    // on any error, try to advance
    advanceToNextPlaylist();
  }
}

/* advance to next playlist and start playback */
function advanceToNextPlaylist(){
  currentPlaylistIndex = (currentPlaylistIndex + 1) % PLAYLISTS.length;
  // small timeout to allow UI to settle
  setTimeout(()=> {
    playPlaylistIndex(currentPlaylistIndex);
  }, 600);
}

/* Show the mini player UI (without loading content here) */
function showMiniPlayer(title){
  const m = $('miniPlayer');
  $('miniTitle').textContent = title || 'YouTube';
  $('miniOpen').href = PLAYLISTS[currentPlaylistIndex] && PLAYLISTS[currentPlaylistIndex].playlistId ? `https://www.youtube.com/playlist?list=${PLAYLISTS[currentPlaylistIndex].playlistId}` : '#';
  m.style.display = 'block'; m.setAttribute('aria-hidden','false');
}

/* fallback message for placeholder playlists */
function showMiniPlayerFallbackMessage(title){
  const m = $('miniPlayer');
  $('miniTitle').textContent = title || 'YouTube';
  $('miniOpen').href = '#';
  const body = $('miniBody');
  body.querySelector('#yt-player') && (body.querySelector('#yt-player').innerHTML = `<div style="padding:12px;color:#bfeffd">Playlist "${title}" requiere ID real. Si quieres, puedo buscar playlists reales y ponerlas aquí.</div>`);
  m.style.display = 'block'; m.setAttribute('aria-hidden','false');
}

/* play a single video in the mini player (not a playlist) */
function playSingleVideo(videoId, title){
  currentPlaylistIndex = 0;
  isUsingPlaylistPlayer = false;
  // if YT API loaded, create a player that loads a single video
  if(YT_API_loaded){
    if(playlistPlayer){
      try {
        playlistPlayer.loadVideoById && playlistPlayer.loadVideoById(videoId);
      } catch(e){
        // replace instance
        playlistPlayer.destroy && playlistPlayer.destroy();
        playlistPlayer = new YT.Player('yt-player', {
          height: '160',
          width: '300',
          videoId: videoId,
          playerVars: { autoplay: 1, controls: 1, modestbranding: 1 },
          events: { onReady: (e)=> e.target.playVideo(), onStateChange: onPlaylistStateChange }
        });
      }
    } else {
      playlistPlayer = new YT.Player('yt-player', {
        height: '160',
        width: '300',
        videoId: videoId,
        playerVars: { autoplay: 1, controls: 1, modestbranding: 1 },
        events: { onReady: (e)=> e.target.playVideo(), onStateChange: onPlaylistStateChange }
      });
    }
  } else {
    const body = $('miniBody');
    body.querySelector('#yt-player') && (body.querySelector('#yt-player').innerHTML = `<iframe width="100%" height="140" src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`);
  }
  showMiniPlayer(title);
}

/* stop and hide mini player */
function stopYT(){
  if(playlistPlayer && playlistPlayer.stopVideo) playlistPlayer.stopVideo();
  const m = $('miniPlayer');
  m.style.display = 'none';
  m.setAttribute('aria-hidden','true');
  const body = $('miniBody');
  const container = body.querySelector('#yt-player');
  if(container && container.tagName === 'IFRAME') container.src='';
}

/* mini-player controls */
$('miniPlay').addEventListener('click', ()=> { if(playlistPlayer && playlistPlayer.playVideo) playlistPlayer.playVideo(); });
$('miniPause').addEventListener('click', ()=> { if(playlistPlayer && playlistPlayer.pauseVideo) playlistPlayer.pauseVideo(); });
$('miniStop').addEventListener('click', ()=> { if(playlistPlayer && playlistPlayer.stopVideo) playlistPlayer.stopVideo(); stopYT(); });
$('miniClose').addEventListener('click', ()=> stopYT());
$('miniToggleSize').addEventListener('click', ()=>{
  const m = $('miniPlayer');
  m.classList.toggle('small');
});

/* draggable mini-player (header) */
(function(){
  const mp = $('miniPlayer');
  const hdr = $('miniHeader');
  let dragging=false, ox=0, oy=0;
  hdr.addEventListener('mousedown', e=>{
    dragging=true;
    ox = e.clientX - mp.offsetLeft;
    oy = e.clientY - mp.offsetTop;
    e.preventDefault();
  });
  document.addEventListener('mousemove', e=>{
    if(!dragging) return;
    mp.style.left = (e.clientX - ox) + 'px';
    mp.style.top = (e.clientY - oy) + 'px';
    mp.style.right = 'auto';
    mp.style.bottom = 'auto';
  });
  document.addEventListener('mouseup', ()=> dragging=false);
  hdr.addEventListener('touchstart', e=>{
    dragging=true;
    const t = e.touches[0];
    ox = t.clientX - mp.offsetLeft;
    oy = t.clientY - mp.offsetTop;
  });
  document.addEventListener('touchmove', e=>{
    if(!dragging) return;
    const t = e.touches[0];
    mp.style.left = (t.clientX - ox) + 'px';
    mp.style.top = (t.clientY - oy) + 'px';
    mp.style.right = 'auto';
    mp.style.bottom = 'auto';
  });
  document.addEventListener('touchend', ()=> dragging=false);
})();

/* audioOnly toggle (hides the iframe visually) */
$('audioOnlyToggle').addEventListener('change', applyAudioOnly);
function applyAudioOnly(){
  const audioOnly = $('audioOnlyToggle').checked;
  const mp = $('miniPlayer');
  if(!mp || mp.style.display==='none') return;
  if(YT_API_loaded && playlistPlayer && playlistPlayer.getIframe){
    const iframe = playlistPlayer.getIframe();
    if(iframe){
      if(audioOnly){
        iframe.style.width='1px'; iframe.style.height='1px'; iframe.style.opacity='0'; iframe.style.pointerEvents='none';
      } else {
        iframe.style.width='100%'; iframe.style.height='160px'; iframe.style.opacity='1'; iframe.style.pointerEvents='auto';
      }
    }
  } else {
    const body = $('miniBody');
    const ifr = body.querySelector('iframe');
    if(ifr){
      if(audioOnly){ ifr.style.width='1px'; ifr.style.height='1px'; ifr.style.opacity='0'; }
      else { ifr.style.width='100%'; ifr.style.height='140px'; ifr.style.opacity='1'; }
    }
  }
}

/* ---------- Search (simple client-side filter of YT_POOL) ---------- */
function doSearch(){
  const k = $('ytKeyword').value.trim().toLowerCase();
  if(!k){ loadDailyRecs(); return; }
  const results = YT_POOL.filter(p => p.title.toLowerCase().includes(k));
  if(results.length) renderYTGrid(results);
  else renderYTGrid(dailyRotation(YT_POOL,6));
}

/* ---------- Subscription form ---------- */
$('subForm').addEventListener('submit', e=>{
  e.preventDefault();
  $('subInfo').textContent = '¡Gracias! Te hemos suscrito (demo)';
  $('emailInput').value = '';
});

/* ---------- Load daily recommendations (6 items) ---------- */
function loadDailyRecs(){
  const items = dailyRotation(YT_POOL, 6);
  renderYTGrid(items);
}

/* ---------- Init ---------- */
function init(){
  updateDisplays();
  loadArticles();
  loadDailyRecs();
  renderYTGrid(dailyRotation(YT_POOL,6));
  loadDailyMusic();
}
init();

/* ---------- expose utility to allow external playlist-swap (optional) ---------- */
window.replacePlaylists = function(newPlaylists){
  // newPlaylists: [{title, playlistId}, ...]
  if(Array.isArray(newPlaylists) && newPlaylists.length){
    PLAYLISTS.length = 0;
    newPlaylists.forEach(p => PLAYLISTS.push(p));
    currentPlaylistIndex = 0;
    // start first playlist automatically
    playPlaylistIndex(0);
  }
};
</script>
</body>
</html>