<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CorAlma — Encuentra tu calma</title>
<meta name="description" content="Meditaciones, sonidos y artículos dinámicos (Wikipedia, Reddit, arXiv). Sonidos con fallback entre servidores." />
<style>
:root{
  --bg1:#020414; --bg2:#041428;
  --accent1:#6ec6d9; --accent2:#8a6cff;
  --glass: rgba(255,255,255,0.04);
  --muted:#9fd8ea;
  --text:#e6f9ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background:
    radial-gradient(circle at 10% 10%, rgba(138,108,255,0.06), transparent 6%),
    radial-gradient(circle at 90% 70%, rgba(110,198,217,0.04), transparent 10%),
    linear-gradient(180deg,var(--bg1), var(--bg2));
  color:var(--text); -webkit-font-smoothing:antialiased;min-height:100vh;
}
.container{max-width:1180px;margin:24px auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021018}
h1{font-size:18px;margin:0}
nav{display:flex;gap:10px;align-items:center}
nav a{color:#cfeffb;text-decoration:none;padding:8px 10px;border-radius:9px}
nav a:hover{background:var(--glass)}

/* hero */
.hero{margin-top:14px;border-radius:14px;padding:28px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));display:flex;gap:20px;align-items:center;position:relative;overflow:hidden}
.hero-left{flex:1;z-index:2}
.hero h2{margin:0;font-size:26px}
.hero p{margin-top:8px;color:#cfeef6}
.cta{margin-top:14px}
.btn-primary{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021018;padding:10px 16px;border-radius:12px;border:0;font-weight:700;cursor:pointer}

/* hero visuals */
.hero-visual{width:260px;display:flex;align-items:center;justify-content:center;z-index:1}

/* grid */
.grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-top:22px}
main{min-width:0}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:18px;border-radius:12px}
.med-card{max-width:760px;margin:0 auto;padding:22px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);box-shadow:0 10px 40px rgba(15,30,50,0.45)}
.center{display:flex;flex-direction:column;align-items:center;gap:12px}
.selector-row{display:flex;gap:10px;align-items:center;width:100%;justify-content:center;flex-wrap:wrap}
select{background:transparent;color:#dff8ff;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
.timer-btns{display:flex;gap:8px}
.timer-btns button{padding:8px 12px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:#dff8ff;cursor:pointer}
.time-display{font-weight:700}

/* circular CTA */
.med-circle{width:170px;height:170px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#021018;font-weight:700;font-size:16px;cursor:pointer;box-shadow:0 12px 40px rgba(60,80,120,0.18);transition:transform .18s ease, box-shadow .18s}
.med-circle:hover{transform:scale(1.03)}
.pulse { animation: pulse 2000ms infinite; }
@keyframes pulse {0%{box-shadow:0 8px 28px rgba(138,108,255,0.22)}50%{box-shadow:0 18px 44px rgba(110,198,217,0.20)}100%{box-shadow:0 8px 28px rgba(138,108,255,0.22)}}

/* articles */
.articles-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:12px}
.article-card{padding:14px;border-radius:10px;background:rgba(255,255,255,0.01);text-align:left}
.article-card h3{margin:0 0 8px 0}
.article-card p{margin:0;color:#cfeef7}
.read-btn{margin-top:10px;padding:8px 10px;border-radius:10px;border:0;background:rgba(255,255,255,0.04);color:#dff8ff;cursor:pointer}

/* right side */
aside{position:relative}
.side-block{display:flex;flex-direction:column;gap:14px}
.sounds-list{max-height:320px;overflow:auto;padding-right:6px}
.sound-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01)}
.notice{font-size:13px;color:#ffd7a8;background:rgba(0,0,0,0.15);padding:8px;border-radius:8px;margin-top:8px}

/* footer */
footer{margin-top:28px;padding:18px 0;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.socials{display:flex;gap:12px}
.socials a{display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:8px;background:rgba(255,255,255,0.03)}
.socials svg{width:20px;height:20px;fill:#e6f9ff}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,6,12,0.65);display:none;align-items:center;justify-content:center;padding:18px;z-index:80}
.modal-back.on{display:flex}
.modal{background:linear-gradient(180deg,#031425,#041a2a);border-radius:12px;padding:18px;max-width:920px;width:100%;max-height:90vh;overflow:auto}
.modal h2{margin-top:0}
.refs{margin-top:18px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px}

/* floating sidebar */
.floating-sidebar{position:fixed;right:12px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:10px;z-index:1000}
.floating-btn{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .18s}
.floating-btn:hover{transform:scale(1.08);background:rgba(255,255,255,0.08)}

/* webview banner */
.webview-banner{position:fixed;left:12px;right:12px;bottom:12px;background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021018;padding:10px 12px;border-radius:12px;display:none;z-index:90;box-shadow:0 12px 40px rgba(10,20,40,0.5)}
.webview-banner button{margin-left:12px;background:transparent;border:1px solid rgba(2,16,24,0.08);padding:6px 8px;border-radius:8px;cursor:pointer}

/* stars animation */
.stars { position:absolute; inset:0; pointer-events:none; z-index:0; opacity:0.28 }
.star { fill: white; opacity:0.9; filter: blur(0.6px); transform-origin:center; animation: twinkle 4s infinite; }
@keyframes twinkle { 0%{opacity:0.7} 50%{opacity:1} 100%{opacity:0.7} }

/* planet float */
.planet { animation: floatPlanet 8s ease-in-out infinite; transform-origin:center; }
@keyframes floatPlanet { 0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)} }

@media(max-width:980px){.grid{grid-template-columns:1fr}.articles-grid{grid-template-columns:1fr}.hero{flex-direction:column}.med-card{width:100%}}
@media(max-width:520px){.med-circle{width:150px;height:150px;font-size:14px}}
button:focus, a:focus { outline: 2px dashed rgba(110,198,217,0.35); outline-offset: 3px; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">CA</div>
        <div>
          <h1>CorAlma</h1>
          <div style="font-size:12px;color:#bfeffd">Encuentra tu calma en el universo interior</div>
        </div>
      </div>
      <nav>
        <a href="#">Inicio</a>
        <a href="#medit-block">Meditación</a>
        <a href="#art">Artículos</a>
        <a href="#reg">Registro</a>
        <a href="#don">Donaciones</a>
        <a href="#contact">Contacto</a>
      </nav>
    </header>

    <!-- HERO -->
    <section class="hero" aria-labelledby="hero-title">
      <div class="hero-left">
        <h2 id="hero-title">Encuentra calma y presencia con prácticas basadas en ciencia y tradición</h2>
        <p>Sonidos curados, meditaciones guiadas y artículos con referencias científicas para sostener tu práctica.</p>
        <div class="cta"><button class="btn-primary" onclick="document.getElementById('medit-block').scrollIntoView({behavior:'smooth'})">Iniciar Meditación</button></div>
      </div>

      <!-- planet + stars visual -->
      <div class="hero-visual" aria-hidden="true">
        <svg width="260" height="260" viewBox="0 0 200 200">
          <g class="stars">
            <circle class="star" cx="20" cy="30" r="1.6" style="animation-delay:0s"/>
            <circle class="star" cx="40" cy="70" r="1.2" style="animation-delay:0.8s"/>
            <circle class="star" cx="80" cy="20" r="1.4" style="animation-delay:1.2s"/>
            <circle class="star" cx="150" cy="50" r="1.8" style="animation-delay:0.3s"/>
            <circle class="star" cx="170" cy="120" r="1.3" style="animation-delay:1.7s"/>
            <circle class="star" cx="110" cy="150" r="1.1" style="animation-delay:2.4s"/>
            <circle class="star" cx="30" cy="140" r="1.5" style="animation-delay:1.1s"/>
          </g>
          <g class="planet" transform="translate(40,20)">
            <defs>
              <linearGradient id="pgrad" x1="0" x2="1">
                <stop offset="0" stop-color="#6ec6d9"/>
                <stop offset="1" stop-color="#8a6cff"/>
              </linearGradient>
            </defs>
            <circle cx="60" cy="60" r="50" fill="url(#pgrad)" opacity="0.95"/>
            <ellipse cx="60" cy="68" rx="62" ry="14" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="2" transform="rotate(-18 60 60)"/>
            <circle cx="42" cy="50" r="6" fill="rgba(255,255,255,0.06)"/>
          </g>
        </svg>
      </div>
    </section>

    <!-- MAIN GRID -->
    <div class="grid">
      <main>
        <!-- Meditation card (central) -->
        <section id="medit-block" class="card med-card" aria-labelledby="medit-title">
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <h3 id="medit-title" style="margin:0">Meditación interactiva</h3>
            <p style="margin:0;color:#cfeef7">Selecciona sonido, elige duración y haz click en el círculo para comenzar.</p>

            <div class="selector-row" style="margin-top:12px">
              <label for="soundSelect" style="color:#bfeffd">Selecciona sonido</label>
              <select id="soundSelect" aria-label="Selecciona sonido"></select>
            </div>

            <div class="selector-row" style="margin-top:6px">
              <div class="timer-btns" role="group" aria-label="Duraciones">
                <button onclick="setTimer(300)">5 min</button>
                <button onclick="setTimer(600)">10 min</button>
                <button onclick="setTimer(900)">15 min</button>
              </div>
              <div style="flex:1"></div>
              <div class="time-display" aria-live="polite">Tiempo: <span id="timeDisplay">00:00</span></div>
            </div>

            <!-- Circular CTA -->
            <div style="margin-top:14px" class="center">
              <div id="medCircle" class="med-circle pulse" role="button" aria-label="Click aquí para meditar" tabindex="0">
                Click aquí<br><span style="font-size:12px;opacity:0.9">para meditar</span>
              </div>
            </div>

            <!-- controls -->
            <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
              <button id="startBtn" class="btn-primary">Iniciar</button>
              <button id="stopBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfeef7;padding:8px 12px;border-radius:10px">Detener</button>
            </div>

            <div id="audioNotice" class="notice" style="display:none"></div>

            <!-- hidden audio -->
            <audio id="audioPlayer" preload="none" controls style="display:none"></audio>
          </div>
        </section>

        <!-- ARTICLES -->
        <section class="card" style="margin-top:16px" id="art">
          <h3 style="margin-top:0">Artículos</h3>
          <div class="articles-grid" id="articlesGrid" role="list"></div>
        </section>
      </main>

      <!-- RIGHT / SIDEBAR -->
      <aside>
        <div class="side-block">
          <div class="card" aria-labelledby="sounds-title">
            <h4 id="sounds-title" style="margin-top:0">Selector de sonidos</h4>
            <div class="sounds-list" id="soundsList">Cargando pistas... (prueba varias fuentes en background)</div>
          </div>

          <div class="card" id="reg">
            <h4 style="margin-top:0">Registro / Frase mensual</h4>
            <form id="subForm">
              <input id="emailInput" type="email" placeholder="tu@correo.com" required style="width:100%;padding:10px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:#dff8ff">
              <div style="margin-top:10px"><button class="btn-primary" type="submit">Suscribirme</button></div>
            </form>
            <div id="subInfo" style="margin-top:12px;color:#bfeffd"></div>
          </div>

          <div class="card" id="don">
            <h4 style="margin-top:0">Donaciones</h4>
            <p style="margin:0 0 10px 0;color:#cfeef7">Si valoras este proyecto, apóyalo. Las donaciones mantienen el contenido libre.</p>
            <a class="btn-primary" href="https://www.paypal.com/donate" target="_blank" rel="noopener">Donar con PayPal</a>
          </div>
        </div>
      </aside>
    </div>

    <!-- footer / contacto -->
    <footer id="contact">
      <div style="color:#9fd8ea">
        Contacto: <a href="mailto:almacoralma@gmail.com">almacoralma@gmail.com</a>
      </div>
      <div class="socials" aria-label="Redes sociales">
        <a href="https://www.instagram.com/effectno33?igsh=MjAycWE4dTFsbXpw" target="_blank" rel="noopener" title="Instagram">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9zM18.5 6a.9.9 0 1 1 0 1.8.9.9 0 0 1 0-1.8z" fill="#e6f9ff"/></svg>
        </a>
        <a href="https://www.tiktok.com/@effect.33?_t=ZS-8znP36atx8n&_r=1" target="_blank" rel="noopener" title="TikTok">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15 2v7.1a4.5 4.5 0 0 1-4.5-4.5H9A6 6 0 1 0 15 15.9V9h3V2h-3z" fill="#e6f9ff"/></svg>
        </a>
        <a href="https://youtube.com/@effect.no33?si=5A83WFm9vvf_DBRv" target="_blank" rel="noopener" title="YouTube">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M23 7s-.2-1.6-1-2.3c-.9-.9-1.9-.9-2.4-1C16.9 3 12 3 12 3s-4.9 0-7.6.7c-.5.1-1.4.1-2.4 1C1.2 5.4 1 7 1 7S1 8.9 1.1 10.8c.1 1.9.5 2.8 1.1 3.6.9 1.1 2.2 1.1 2.8 1.2 2.1.2 8 .6 8 .6s4.9-.2 7.6-.8c.5-.1 1.9-.1 2.8-1.2.6-.8 1-1.7 1.1-3.6C23 8.9 23 7 23 7zM9.8 15.2V8.8l6 3.2-6 3.2z" fill="#e6f9ff"/></svg>
        </a>
      </div>
    </footer>
  </div>

  <!-- floating sidebar (socials only) -->
  <div class="floating-sidebar" aria-hidden="false">
    <a class="floating-btn" href="https://www.instagram.com/effectno33?igsh=MjAycWE4dTFsbXpw" target="_blank" title="Instagram" rel="noopener" aria-label="Instagram">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9zM18.5 6a.9.9 0 1 1 0 1.8.9.9 0 0 1 0-1.8z" fill="#e6f9ff"/></svg>
    </a>
    <a class="floating-btn" href="https://www.tiktok.com/@effect.33?_t=ZS-8znP36atx8n&_r=1" target="_blank" title="TikTok" rel="noopener" aria-label="TikTok">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M15 2v7.1a4.5 4.5 0 0 1-4.5-4.5H9A6 6 0 1 0 15 15.9V9h3V2h-3z" fill="#e6f9ff"/></svg>
    </a>
    <a class="floating-btn" href="https://youtube.com/@effect.no33?si=5A83WFm9vvf_DBRv" target="_blank" title="YouTube" rel="noopener" aria-label="YouTube">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M23 7s-.2-1.6-1-2.3c-.9-.9-1.9-.9-2.4-1C16.9 3 12 3 12 3s-4.9 0-7.6.7c-.5.1-1.4.1-2.4 1C1.2 5.4 1 7 1 7S1 8.9 1.1 10.8c.1 1.9.5 2.8 1.1 3.6.9 1.1 2.2 1.1 2.8 1.2 2.1.2 8 .6 8 .6s4.9-.2 7.6-.8c.5-.1 1.9-.1 2.8-1.2.6-.8 1-1.7 1.1-3.6C23 8.9 23 7 23 7zM9.8 15.2V8.8l6 3.2-6 3.2z" fill="#e6f9ff"/></svg>
    </a>
  </div>

  <!-- modal -->
  <div id="modalBack" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle"></h2>
      <div id="modalBody" style="color:#dffcff;line-height:1.6"></div>
      <div id="modalRefs" class="refs" style="color:#bfeffd"></div>
      <div style="text-align:right;margin-top:12px">
        <button id="closeModal" class="btn-primary" style="background:transparent;color:#bfeffd;border:1px solid rgba(255,255,255,0.06)">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- webview banner -->
  <div id="webviewBanner" class="webview-banner" role="status">
    Para una mejor experiencia abre esta página en tu navegador (Chrome o Safari).
    <button id="dismissWebview">Cerrar</button>
  </div>

<script>
/* CorAlma: client-only app
   - Multi-source audio fallback
   - Dynamic article fetch (Wikipedia, Reddit, arXiv) and 15-day rotation
   - All state in localStorage where needed
*/

/* ---------- Utilities ---------- */
const $ = selector => document.querySelector(selector);
const $$ = selector => Array.from(document.querySelectorAll(selector));

/* ---------- Articles dynamic fetching + 15-day rotation ---------- */
const ARTICLES_KEY = 'coralma_articles_v1';
const ARTICLES_DATE_KEY = 'coralma_articles_date_v1';
const ROTATE_DAYS = 15; // rotate every 15 days
const MAX_ARTICLES = 30;

async function fetchWikipediaTopics(topics = ['Meditation','Mindfulness','Neuroscience','Mind–body_interventions','Gratitude']) {
  // returns array of {title, extract, url}
  try {
    const results = [];
    for (const t of topics) {
      const api = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(t)}`;
      try {
        const res = await fetch(api);
        if(!res.ok) continue;
        const json = await res.json();
        if(json && json.title) {
          results.push({
            source: 'Wikipedia',
            title: json.title,
            extract: json.extract || '',
            url: json.content_urls ? json.content_urls.desktop.page : `https://en.wikipedia.org/wiki/${encodeURIComponent(t)}`,
            content: json.extract || ''
          });
        }
      } catch(e){}
    }
    return results;
  } catch(e){ return []; }
}

async function fetchRedditPosts(subreddits = ['Meditation','Philosophy']) {
  // returns array of {title, extract, url}
  try {
    const results = [];
    for(const s of subreddits){
      const api = `https://www.reddit.com/r/${s}/hot.json?limit=12`;
      try {
        const res = await fetch(api);
        if(!res.ok) continue;
        const json = await res.json();
        if(json && json.data && json.data.children){
          for(const ch of json.data.children){
            const d = ch.data;
            results.push({
              source: `r/${s}`,
              title: d.title,
              extract: (d.selftext && d.selftext.substring(0,300)) || '',
              url: `https://reddit.com${d.permalink}`,
              content: d.selftext || ''
            });
          }
        }
      } catch(e){}
    }
    return results;
  } catch(e){ return []; }
}

async function fetchArxiv(query='mindfulness OR meditation', max=20) {
  // arXiv API RSS: we'll fetch an ATOM feed and parse minimal info.
  // Note: arXiv has CORS restrictions sometimes; handle gracefully.
  try {
    const api = `https://export.arxiv.org/api/query?search_query=all:${encodeURIComponent(query)}&start=0&max_results=${max}`;
    const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(api)}`); // proxy to bypass CORS (allorigins.win)
    if(!res.ok) return [];
    const text = await res.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, "application/xml");
    const entries = Array.from(xml.querySelectorAll('entry')).slice(0, max);
    const results = entries.map(e=>{
      const title = (e.querySelector('title') && e.querySelector('title').textContent) || 'arXiv article';
      const summary = (e.querySelector('summary') && e.querySelector('summary').textContent) || '';
      const link = (e.querySelector('id') && e.querySelector('id').textContent) || '';
      return { source: 'arXiv', title, extract: summary.substring(0,400), url: link, content: summary };
    });
    return results;
  } catch(e){ return []; }
}

/* Compose an articles set by pulling from multiple sources */
async function buildArticles() {
  // try to fetch from Wikipedia, Reddit, arXiv
  const [w, r, a] = await Promise.all([
    fetchWikipediaTopics(['Meditation','Mindfulness','Neuroscience','Gratitude','Compassion','Breathing_techniques']),
    fetchRedditPosts(['Meditation','Philosophy','psychology']),
    fetchArxiv('mindfulness OR meditation', 15)
  ]);
  // merge and pick up to MAX_ARTICLES
  const merged = [];
  if(w && w.length) merged.push(...w);
  if(a && a.length) merged.push(...a);
  if(r && r.length) merged.push(...r);
  // normalize and dedupe by title
  const byTitle = new Map();
  merged.forEach(it => {
    if(!it || !it.title) return;
    if(!byTitle.has(it.title)) byTitle.set(it.title, {
      id: byTitle.size + 1,
      title: it.title,
      excerpt: (it.extract || '').slice(0,220),
      content: it.content || it.extract || '',
      refs: [it.source + ' • ' + (it.url || '')],
      sourceUrl: it.url || ''
    });
  });
  // If not enough articles, fallback to local (below)
  const arr = Array.from(byTitle.values()).slice(0, MAX_ARTICLES);
  if(arr.length < MAX_ARTICLES) {
    // add fallback from built-in local list (see localArticles below)
    const need = MAX_ARTICLES - arr.length;
    arr.push(...localArticles.slice(0, need));
  }
  // assign consistent ids 1..N
  arr.forEach((a,i)=>a.id=i+1);
  return arr;
}

/* Use local fallback articles if remote fetching fails */
const localArticles = [
  {id:1,title:"Respira: el primer acto de presencia",excerpt:"La respiración es la puerta de entrada al presente.",content:"La respiración consciente... (texto completo aquí)",refs:["Brown & Gerbarg (2005)","Harvard Health"]},
  {id:2,title:"Micro-prácticas para la calma",excerpt:"Pequeñas pausas a lo largo del día...",content:"Texto completo...",refs:["Sonnentag (2018)"]},
  {id:3,title:"Música clásica como paisaje interior",excerpt:"Piano suave y cuerdas facilitan la relajación.",content:"Texto completo...",refs:["Juslin & Västfjäll (2008)"]},
  // ... (si quieres, puedo expandir esta lista local)
];

/* Save & load articles with 15-day rotation */
async function getArticlesForDisplay() {
  const stored = JSON.parse(localStorage.getItem(ARTICLES_KEY) || 'null');
  const dateSaved = localStorage.getItem(ARTICLES_DATE_KEY);
  const now = Date.now();
  const needsRefresh = !stored || !dateSaved || ((now - parseInt(dateSaved,10)) > ROTATE_DAYS * 24*3600*1000);
  if(!needsRefresh) return stored;
  // build new set
  try {
    const newArticles = await buildArticles();
    localStorage.setItem(ARTICLES_KEY, JSON.stringify(newArticles));
    localStorage.setItem(ARTICLES_DATE_KEY, String(now));
    return newArticles;
  } catch(e){
    // fallback to localArticles
    localStorage.setItem(ARTICLES_KEY, JSON.stringify(localArticles));
    localStorage.setItem(ARTICLES_DATE_KEY, String(now));
    return localArticles;
  }
}

/* ---------- Audio handling with multi-server fallback ---------- */
/*
  We maintain a list of tracks. Each track has a title and an array of candidate URLs (order = preference).
  tryPlayTrack will test URLs sequentially (with timeouts/events) until audio can play.
  If none of a track's URLs work, pick a different track randomly and inform user.
*/

// Example candidate URLs — each entry is a list of candidate sources.
// NOTE: many URLs are public/test endpoints. You can replace/add your own stable urls.
// The code will attempt each url until one plays.
const TRACKS = [
  { title: 'Ambient — Space Pad 1', urls: [
    'https://archive.org/download/ambient-space-pad/ambient_space_pad_1.mp3',
    'https://upload.wikimedia.org/wikipedia/commons/4/4b/Example.ogg', // example fallback (may not be audio)
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'
  ]},
  { title: 'Ambient — Forest Water', urls: [
    'https://archive.org/download/forest-waves/forest_waves.mp3',
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3'
  ]},
  { title: 'Piano Sereno 1', urls: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
    'https://upload.wikimedia.org/wikipedia/commons/4/4b/Example.ogg'
  ]},
  { title: 'Piano Sereno 2', urls: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3'
  ]},
  { title: 'Strings Pad', urls: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3'
  ]},
  { title: 'Calm Piano 3', urls: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3'
  ]},
  { title: 'Nature Rain', urls: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3'
  ]},
  { title: 'Ambient Drone 2', urls: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3'
  ]},
  { title: 'Piano Loop', urls: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-9.mp3'
  ]},
  { title: 'Calm Strings 2', urls: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3'
  ]},
  // Add more tracks until 20 (we'll duplicate some sensible ones for demo)
  { title: 'Ambient — Wind 1', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-11.mp3']},
  { title: 'Ambient — Wind 2', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-12.mp3']},
  { title: 'Piano — Solo 4', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-13.mp3']},
  { title: 'Piano — Solo 5', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-14.mp3']},
  { title: 'Strings — Soft 3', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3']},
  { title: 'Ambient — Ocean', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-16.mp3']},
  { title: 'Nature — Birds', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-17.mp3']},
  { title: 'Drone — Soft 4', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-18.mp3']},
  { title: 'Piano — Lento', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-19.mp3']},
  { title: 'Calm Mix', urls: ['https://www.soundhelix.com/examples/mp3/SoundHelix-Song-20.mp3']}
];

// Note: You should replace archive.org / wikimedia placeholders with real file URLs if you have them.
// SoundHelix example MP3s are stable for testing and useful as fallback/demo.

let CURRENT_TRACK_INDEX = 0;
let CURRENT_URL_INDEX = 0;
const audio = document.getElementById('audioPlayer');
const audioNotice = document.getElementById('audioNotice');

// set up UI lists
function populateTrackUI() {
  const select = document.getElementById('soundSelect');
  select.innerHTML = '';
  const list = document.getElementById('soundsList');
  list.innerHTML = '';
  TRACKS.forEach((t,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = t.title;
    select.appendChild(opt);

    const row = document.createElement('div');
    row.className = 'sound-item';
    row.innerHTML = `<div style="color:#dff8ff">${t.title}</div>
      <div style="display:flex;gap:6px">
        <button class="mini-play" data-i="${i}">Play</button>
        <button class="mini-use" data-i="${i}">Usar</button>
      </div>`;
    list.appendChild(row);
  });
}

// Try to play a specific track index, testing candidate URLs sequentially.
function tryPlayTrack(trackIndex) {
  const track = TRACKS[trackIndex];
  if(!track) return;
  CURRENT_TRACK_INDEX = trackIndex;
  CURRENT_URL_INDEX = 0;
  audioNotice.style.display = 'none';
  attemptUrlPlay(track);
}

let attemptTimeout = null;
function attemptUrlPlay(track) {
  if(!track || !track.urls || track.urls.length === 0) {
    fallbackToOtherTrack(`No hay URLs para "${track ? track.title : 'track'}"`);
    return;
  }
  if(CURRENT_URL_INDEX >= track.urls.length) {
    // exhausted this track's urls
    fallbackToOtherTrack(`La pista "${track.title}" no está disponible en sus fuentes; probando otra pista.`);
    return;
  }
  const url = track.urls[CURRENT_URL_INDEX];
  // Try to load and detect 'canplaythrough' within X seconds
  let played = false;
  audio.pause();
  audio.src = url;
  audio.load();
  const canplayHandler = () => {
    played = true;
    clearAttemptListeners();
    audio.play().catch(()=>{}); // user interaction may be required in some webviews
    showTemporaryNotice(`Reproduciendo: ${track.title}`);
  };
  const errorHandler = () => {
    // try next url
    clearAttemptListeners();
    CURRENT_URL_INDEX++;
    setTimeout(()=>attemptUrlPlay(track), 200);
  };
  const timeoutHandler = () => {
    if(!played){
      // treat as failure and try next
      clearAttemptListeners();
      CURRENT_URL_INDEX++;
      attemptUrlPlay(track);
    }
  };
  function clearAttemptListeners() {
    audio.removeEventListener('canplaythrough', canplayHandler);
    audio.removeEventListener('error', errorHandler);
    if(attemptTimeout) { clearTimeout(attemptTimeout); attemptTimeout = null; }
  }
  audio.addEventListener('canplaythrough', canplayHandler, {once:true});
  audio.addEventListener('error', errorHandler, {once:true});
  // safety timeout if canplaythrough doesn't fire
  attemptTimeout = setTimeout(timeoutHandler, 6000); // 6s
}

function fallbackToOtherTrack(msg) {
  showTemporaryNotice(msg || 'Cambiando a otra pista...');
  // pick a random track different from current
  const idxs = TRACKS.map((_,i)=>i).filter(i=>i!==CURRENT_TRACK_INDEX);
  const next = idxs[Math.floor(Math.random()*idxs.length)];
  CURRENT_TRACK_INDEX = next;
  CURRENT_URL_INDEX = 0;
  // update select
  const sel = document.getElementById('soundSelect');
  if(sel) sel.value = String(next);
  attemptUrlPlay(TRACKS[next]);
}

let noticeTimeout = null;
function showTemporaryNotice(text, duration=4000) {
  audioNotice.textContent = text;
  audioNotice.style.display = 'block';
  if(noticeTimeout) clearTimeout(noticeTimeout);
  noticeTimeout = setTimeout(()=>{ audioNotice.style.display = 'none'; }, duration);
}

/* ---------- UI interactions ---------- */
document.addEventListener('click', (e)=>{
  const p = e.target.closest('.mini-play');
  if(p){
    const i = Number(p.dataset.i);
    tryPlayTrack(i);
  }
  const u = e.target.closest('.mini-use');
  if(u){
    const i = Number(u.dataset.i);
    document.getElementById('soundSelect').value = String(i);
    tryPlayTrack(i);
  }
  const r = e.target.closest('.read-btn');
  if(r){
    const id = r.dataset.id;
    if(id) openArticle(id);
  }
});

// sound select change (update current track index but don't auto-play)
document.getElementById('soundSelect')?.addEventListener('change', function(){
  const i = Number(this.value);
  CURRENT_TRACK_INDEX = i;
  CURRENT_URL_INDEX = 0;
  // set audio src to first candidate but do not autoplay (respect browser)
  if(TRACKS[i] && TRACKS[i].urls && TRACKS[i].urls[0]) {
    audio.src = TRACKS[i].urls[0];
  }
});

/* ---------- Meditation timer & controls ---------- */
let timer = 0; let tick = null;
function setTimer(sec){ timer = sec; updateTime(); }
function updateTime(){ const mm = String(Math.floor(timer/60)).padStart(2,'0'); const ss = String(timer%60).padStart(2,'0'); document.getElementById('timeDisplay').textContent = `${mm}:${ss}`; }
function startMeditation(){
  if(timer <= 0){ alert('Selecciona duración (5/10/15 min)'); return; }
  // Start audio if currently set; if not, start current track attempt
  if(!audio.src || audio.src === '') {
    tryPlayTrack(CURRENT_TRACK_INDEX || 0);
  } else {
    audio.play().catch(()=>{ /* may require interaction */ });
  }
  document.getElementById('medCircle').classList.remove('pulse');
  document.getElementById('medCircle').style.transform='scale(0.98)';
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  tick = setInterval(()=>{ if(timer>0){ timer--; updateTime(); } else { stopMeditation(); } },1000);
}
function stopMeditation(){
  audio.pause(); audio.currentTime = 0;
  document.getElementById('medCircle').classList.add('pulse'); document.getElementById('medCircle').style.transform='';
  document.getElementById('startBtn').disabled = false; document.getElementById('stopBtn').disabled = true;
  clearInterval(tick); tick=null;
}
document.getElementById('medCircle').addEventListener('click', ()=> { if(!tick) startMeditation(); else stopMeditation(); });
document.getElementById('startBtn').addEventListener('click', startMeditation);
document.getElementById('stopBtn').addEventListener('click', stopMeditation);
setTimer(300); updateTime();

/* ---------- Articles rendering ---------- */
async function renderArticlesToUI(){
  const arr = await getArticlesForDisplay();
  const grid = document.getElementById('articlesGrid');
  grid.innerHTML = '';
  arr.slice(0, MAX_ARTICLES).forEach(a=>{
    const el = document.createElement('div');
    el.className = 'article-card';
    el.innerHTML = `<h3>${escapeHtml(a.title)}</h3><p>${escapeHtml(a.excerpt || a.content || '').slice(0,260)}</p><button class="read-btn" data-id="${a.id}">Leer completo</button>`;
    grid.appendChild(el);
  });
}
function openArticle(id){
  const arr = JSON.parse(localStorage.getItem(ARTICLES_KEY) || '[]');
  const a = arr.find(x=>String(x.id)===String(id)) || localArticles.find(x=>String(x.id)===String(id));
  if(!a) return;
  $('#modalTitle').textContent = a.title;
  $('#modalBody').innerHTML = `<p style="margin-top:6px;color:#dffcff;line-height:1.6">${escapeHtml(a.content || a.excerpt || '')}</p>`;
  $('#modalRefs').innerHTML = `<strong>Referencias</strong><ul style="margin-top:8px">${(a.refs || []).map(r=>`<li style="margin-bottom:6px;color:#bfeffd">${escapeHtml(r)}</li>`).join('')}</ul>`;
  modalBack.classList.add('on'); modalBack.setAttribute('aria-hidden','false');
}
$('#closeModal').addEventListener('click', ()=>{ modalBack.classList.remove('on'); modalBack.setAttribute('aria-hidden','true'); });

/* ---------- Subscription ---------- */
$('#subForm').addEventListener('submit', function(e){
  e.preventDefault();
  const email = ($('#emailInput').value || '').trim();
  if(!email.includes('@')) { alert('Introduce un correo válido'); return; }
  localStorage.setItem('coralma_email', email);
  $('#subInfo').textContent = `Suscrito: ${email} · Frase del mes: "${monthlyPhrase()}"`;
  this.style.display = 'none';
});
function monthlyPhrase(){ const arr=['Respira, estás donde debes.','Tu presencia es el acto más sanador.','Hoy es terreno fértil para la calma.','Suelta y respira.']; return arr[Math.floor(Math.random()*arr.length)]; }

/* ---------- WebView detection ---------- */
function isInAppBrowser(){
  const ua = navigator.userAgent || '';
  const apps = ['Instagram','FBAN','FBAV','Twitter','Line','MicroMessenger','TikTok','Snapchat'];
  return apps.some(a => ua.includes(a));
}
if(isInAppBrowser()){
  $('#webviewBanner').style.display = 'block';
}
$('#dismissWebview').addEventListener('click', ()=> $('#webviewBanner').style.display='none');

/* ---------- Helpers ---------- */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }

/* ---------- Init sequence ---------- */
async function initApp(){
  populateTrackUI();
  // set a default current track index if not set
  CURRENT_TRACK_INDEX = 0;
  CURRENT_URL_INDEX = 0;
  if(TRACKS[0] && TRACKS[0].urls && TRACKS[0].urls[0]) {
    audio.src = TRACKS[0].urls[0];
  }
  // show saved subscription
  const saved = localStorage.getItem('coralma_email');
  if(saved){ $('#subInfo').textContent = `Suscrito: ${saved} · Frase del mes: "${monthlyPhrase()}"`; $('#subForm').style.display='none'; }

  // Fetch & render articles (with rotation)
  try {
    await renderArticlesToUI();
  } catch(e){
    // fallback: render local articles
    const grid = document.getElementById('articlesGrid');
    grid.innerHTML = '';
    localArticles.slice(0,MAX_ARTICLES).forEach(a=>{
      const el = document.createElement('div');
      el.className = 'article-card';
      el.innerHTML = `<h3>${escapeHtml(a.title)}</h3><p>${escapeHtml(a.excerpt || '')}</p><button class="read-btn" data-id="${a.id}">Leer completo</button>`;
      grid.appendChild(el);
    });
  }

  // If user opens page and audio files fail repeatedly, UI will show notice as fallback.
}

initApp();

/* Accessibility: close modal with Escape */
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ modalBack.classList.remove('on'); modalBack.setAttribute('aria-hidden','true'); } });

/* End of script */
</script>
</body>
</html>