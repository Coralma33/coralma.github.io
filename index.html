<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CorAlma — Encuentra tu calma</title>
<meta name="description" content="Meditaciones, sonidos y artículos dinámicos (Wikipedia, Reddit, arXiv). Sonidos con fallback entre servidores." />
<style>
:root{
  --bg1:#020414; --bg2:#041428;
  --accent1:#6ec6d9; --accent2:#8a6cff;
  --glass: rgba(255,255,255,0.04);
  --muted:#9fd8ea;
  --text:#e6f9ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background:
    radial-gradient(circle at 10% 10%, rgba(138,108,255,0.06), transparent 6%),
    radial-gradient(circle at 90% 70%, rgba(110,198,217,0.04), transparent 10%),
    linear-gradient(180deg,var(--bg1), var(--bg2));
  color:var(--text); -webkit-font-smoothing:antialiased;min-height:100vh;
}
.container{max-width:1180px;margin:24px auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent1));display:flex;align-items:center;justify-content:center;font-weight:700;color:#021018}
h1{font-size:18px;margin:0}
nav{display:flex;gap:10px;align-items:center}
nav a{color:#cfeffb;text-decoration:none;padding:8px 10px;border-radius:9px}
nav a:hover{background:var(--glass)}

/* hero */
.hero{margin-top:14px;border-radius:14px;padding:28px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));display:flex;gap:20px;align-items:center;position:relative;overflow:hidden}
.hero-left{flex:1;z-index:2}
.hero h2{margin:0;font-size:26px}
.hero p{margin-top:8px;color:#cfeef6}
.cta{margin-top:14px}
.btn-primary{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021018;padding:10px 16px;border-radius:12px;border:0;font-weight:700;cursor:pointer}

/* hero visuals */
.hero-visual{width:260px;display:flex;align-items:center;justify-content:center;z-index:1}

/* grid */
.grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-top:22px}
main{min-width:0}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:18px;border-radius:12px}
.med-card{max-width:760px;margin:0 auto;padding:22px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);box-shadow:0 10px 40px rgba(15,30,50,0.45)}
.center{display:flex;flex-direction:column;align-items:center;gap:12px}
.selector-row{display:flex;gap:10px;align-items:center;width:100%;justify-content:center;flex-wrap:wrap}
select, input[type="text"], input[type="email"]{background:transparent;color:#dff8ff;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
.timer-btns{display:flex;gap:8px}
.timer-btns button{padding:8px 12px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:#dff8ff;cursor:pointer}
.time-display{font-weight:700}

/* circular CTA */
.med-circle{width:170px;height:170px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#021018;font-weight:700;font-size:16px;cursor:pointer;box-shadow:0 12px 40px rgba(60,80,120,0.18);transition:transform .18s ease, box-shadow .18s}
.med-circle:hover{transform:scale(1.03)}
.pulse { animation: pulse 2000ms infinite; }
@keyframes pulse {0%{box-shadow:0 8px 28px rgba(138,108,255,0.22)}50%{box-shadow:0 18px 44px rgba(110,198,217,0.20)}100%{box-shadow:0 8px 28px rgba(138,108,255,0.22)}}

/* articles */
.articles-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-top:12px}
.article-card{padding:14px;border-radius:10px;background:rgba(255,255,255,0.01);text-align:left}
.article-card h3{margin:0 0 8px 0}
.article-card p{margin:0;color:#cfeef7}
.read-btn{margin-top:10px;padding:8px 10px;border-radius:10px;border:0;background:rgba(255,255,255,0.04);color:#dff8ff;cursor:pointer}

/* right side */
aside{position:relative}
.side-block{display:flex;flex-direction:column;gap:14px}
.sounds-list{max-height:320px;overflow:auto;padding-right:6px}
.sound-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01)}
.notice{font-size:13px;color:#ffd7a8;background:rgba(0,0,0,0.15);padding:8px;border-radius:8px;margin-top:8px}

/* footer */
footer{margin-top:28px;padding:18px 0;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.socials{display:flex;gap:12px}
.socials a{display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:8px;background:rgba(255,255,255,0.03)}
.socials svg{width:20px;height:20px;fill:#e6f9ff}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,6,12,0.65);display:none;align-items:center;justify-content:center;padding:18px;z-index:80}
.modal-back.on{display:flex}
.modal{background:linear-gradient(180deg,#031425,#041a2a);border-radius:12px;padding:18px;max-width:920px;width:100%;max-height:90vh;overflow:auto}
.modal h2{margin-top:0}
.refs{margin-top:18px;border-top:1px dashed rgba(255,255,255,0.03);padding-top:12px}

/* floating sidebar */
.floating-sidebar{position:fixed;right:12px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:10px;z-index:1000}
.floating-btn{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .18s}
.floating-btn:hover{transform:scale(1.08);background:rgba(255,255,255,0.08)}

/* webview banner */
.webview-banner{position:fixed;left:12px;right:12px;bottom:12px;background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021018;padding:10px 12px;border-radius:12px;display:none;z-index:90;box-shadow:0 12px 40px rgba(10,20,40,0.5)}
.webview-banner button{margin-left:12px;background:transparent;border:1px solid rgba(2,16,24,0.08);padding:6px 8px;border-radius:8px;cursor:pointer}

/* stars animation */
.stars { position:absolute; inset:0; pointer-events:none; z-index:0; opacity:0.28 }
.star { fill: white; opacity:0.9; filter: blur(0.6px); transform-origin:center; animation: twinkle 4s infinite; }
@keyframes twinkle { 0%{opacity:0.7} 50%{opacity:1} 100%{opacity:0.7} }

/* planet float */
.planet { animation: floatPlanet 8s ease-in-out infinite; transform-origin:center; }
@keyframes floatPlanet { 0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)} }

/* floating player (picture-in-page) */
.floating-player {
  position: fixed;
  bottom: 22px;
  right: 22px;
  width: 240px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  color: var(--text);
  border-radius: 12px;
  box-shadow: 0 14px 50px rgba(0,0,0,0.5);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  user-select: none;
  touch-action: none;
  cursor: grab;
}
.floating-player.expanded { width: 420px; height: auto; }
.fp-header {
  display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:rgba(0,0,0,0.08);
}
.fp-title { font-weight:700; font-size:13px; }
.fp-controls { display:flex; gap:8px; align-items:center; }
.fp-controls button { background:transparent;border:0;color:var(--text);cursor:pointer;padding:6px;border-radius:8px; }
.fp-body { display:flex;gap:10px;align-items:center;padding:10px; }
.fp-body img { width:72px;height:72px;border-radius:8px;object-fit:cover;flex-shrink:0;box-shadow:0 8px 30px rgba(0,0,0,0.5); }
.fp-meta { font-size:13px; color:#cfeef7; }
.floating-player.hidden { display:none; }

/* accessibility focus */
.floating-player:focus { outline: 2px dashed rgba(110,198,217,0.35); outline-offset: 3px; }

/* responsive */
@media(max-width:980px){.grid{grid-template-columns:1fr}.articles-grid{grid-template-columns:1fr}.hero{flex-direction:column}.med-card{width:100%}}
@media(max-width:520px){.med-circle{width:150px;height:150px;font-size:14px}.floating-player{width:200px}}
button:focus, a:focus { outline: 2px dashed rgba(110,198,217,0.35); outline-offset: 3px; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">CA</div>
        <div>
          <h1>CorAlma</h1>
          <div style="font-size:12px;color:#bfeffd">Encuentra tu calma en el universo interior</div>
        </div>
      </div>
      <nav>
        <a href="#">Inicio</a>
        <a href="#medit-block">Meditación</a>
        <a href="#art">Artículos</a>
        <a href="#reg">Registro</a>
        <a href="#don">Donaciones</a>
        <a href="#contact">Contacto</a>
      </nav>
    </header>

    <!-- HERO -->
    <section class="hero" aria-labelledby="hero-title">
      <div class="hero-left">
        <h2 id="hero-title">Encuentra calma y presencia con prácticas basadas en ciencia y tradición</h2>
        <p>Sonidos curados, meditaciones guiadas y artículos con referencias científicas para sostener tu práctica.</p>
        <div class="cta"><button class="btn-primary" onclick="document.getElementById('medit-block').scrollIntoView({behavior:'smooth'})">Iniciar Meditación</button></div>
      </div>

      <!-- planet + stars visual -->
      <div class="hero-visual" aria-hidden="true">
        <svg width="260" height="260" viewBox="0 0 200 200">
          <g class="stars">
            <circle class="star" cx="20" cy="30" r="1.6" style="animation-delay:0s"/>
            <circle class="star" cx="40" cy="70" r="1.2" style="animation-delay:0.8s"/>
            <circle class="star" cx="80" cy="20" r="1.4" style="animation-delay:1.2s"/>
            <circle class="star" cx="150" cy="50" r="1.8" style="animation-delay:0.3s"/>
            <circle class="star" cx="170" cy="120" r="1.3" style="animation-delay:1.7s"/>
            <circle class="star" cx="110" cy="150" r="1.1" style="animation-delay:2.4s"/>
            <circle class="star" cx="30" cy="140" r="1.5" style="animation-delay:1.1s"/>
          </g>
          <g class="planet" transform="translate(40,20)">
            <defs>
              <linearGradient id="pgrad" x1="0" x2="1">
                <stop offset="0" stop-color="#6ec6d9"/>
                <stop offset="1" stop-color="#8a6cff"/>
              </linearGradient>
            </defs>
            <circle cx="60" cy="60" r="50" fill="url(#pgrad)" opacity="0.95"/>
            <ellipse cx="60" cy="68" rx="62" ry="14" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="2" transform="rotate(-18 60 60)"/>
            <circle cx="42" cy="50" r="6" fill="rgba(255,255,255,0.06)"/>
          </g>
        </svg>
      </div>
    </section>

    <!-- MAIN GRID -->
    <div class="grid">
      <main>
        <!-- Meditation card (central) -->
        <section id="medit-block" class="card med-card" aria-labelledby="medit-title">
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
            <h3 id="medit-title" style="margin:0">Meditación interactiva</h3>
            <p style="margin:0;color:#cfeef7">Selecciona sonido, elige duración y haz click en el círculo para comenzar.</p>

            <!-- Buscador de música -->
            <div class="selector-row" style="margin-top:12px">
              <input id="musicQuery" type="text" placeholder="Buscar música (ej. relax binaural)" style="padding:8px;border-radius:10px;min-width:220px">
              <button onclick="searchMusic('google')">Buscar Google</button>
              <button onclick="searchMusic('youtube')">Buscar YouTube</button>
            </div>

            <div class="selector-row" style="margin-top:12px">
              <label for="soundSelect" style="color:#bfeffd">Selecciona sonido</label>
              <select id="soundSelect" aria-label="Selecciona sonido">
                <!-- opciones con miniatura asociada -->
                <option value="rain" data-img="https://i.imgur.com/4NJlJYw.jpg">Lluvia suave</option>
                <option value="forest" data-img="https://i.imgur.com/sB4aVhV.jpg">Bosque</option>
                <option value="waves" data-img="https://i.imgur.com/6Yy7dOi.jpg">Olas</option>
                <option value="binaural" data-img="https://i.imgur.com/3z7Qp6k.jpg">Binaural 7Hz</option>
              </select>
            </div>

            <div class="selector-row" style="margin-top:6px">
              <div class="timer-btns" role="group" aria-label="Duraciones">
                <button onclick="setTimer(300)">5 min</button>
                <button onclick="setTimer(600)">10 min</button>
                <button onclick="setTimer(900)">15 min</button>
              </div>
              <div style="flex:1"></div>
              <div class="time-display" aria-live="polite">Tiempo: <span id="timeDisplay">00:00</span></div>
            </div>

            <!-- Circular CTA -->
            <div style="margin-top:14px" class="center">
              <div id="medCircle" class="med-circle pulse" role="button" aria-label="Click aquí para meditar" tabindex="0">
                Click aquí<br><span style="font-size:12px;opacity:0.9">para meditar</span>
              </div>
            </div>

            <!-- Miniatura y controles -->
            <div id="sessionInfo" style="margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
              <div id="thumbWrap" style="display:none;align-items:center;gap:12px">
                <img id="sessionThumb" src="" alt="Miniatura" style="width:96px;height:96px;border-radius:10px;object-fit:cover;box-shadow:0 8px 30px rgba(0,0,0,0.6)">
                <div>
                  <div id="sessionText" style="font-weight:700"></div>
                  <div id="sessionSub" style="font-size:13px;color:#cfeef7"></div>
                </div>
              </div>

              <div>
                <button id="startBtn" class="btn-primary">Iniciar</button>
                <button id="stopBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfeef7;padding:8px 12px;border-radius:10px">Detener</button>
              </div>
            </div>

            <div id="audioNotice" class="notice" style="display:none"></div>

            <!-- hidden audio -->
            <audio id="audioPlayer" preload="none" controls style="display:none"></audio>
          </div>
        </section>

        <!-- ARTICLES -->
        <section class="card" style="margin-top:16px" id="art">
          <h3 style="margin-top:0">Artículos</h3>
          <div class="articles-grid" id="articlesGrid" role="list"></div>
        </section>
      </main>

      <!-- RIGHT / SIDEBAR -->
      <aside>
        <div class="side-block">
          <div class="card" aria-labelledby="sounds-title">
            <h4 id="sounds-title" style="margin-top:0">Selector de sonidos</h4>
            <div class="sounds-list" id="soundsList">Cargando pistas... (prueba varias fuentes en background)</div>
          </div>

          <div class="card" id="reg">
            <h4 style="margin-top:0">Registro / Frase mensual</h4>
            <form id="subForm">
              <input id="emailInput" type="email" placeholder="tu@correo.com" required style="width:100%;padding:10px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:#dff8ff">
              <div style="margin-top:10px"><button class="btn-primary" type="submit">Suscribirme</button></div>
            </form>
            <div id="subInfo" style="margin-top:12px;color:#bfeffd"></div>
          </div>

          <div class="card" id="don">
            <h4 style="margin-top:0">Donaciones</h4>
            <p style="margin:0 0 10px 0;color:#cfeef7">Si valoras este proyecto, apóyalo. Las donaciones mantienen el contenido libre.</p>
            <a class="btn-primary" href="https://www.paypal.com/donate" target="_blank" rel="noopener">Donar con PayPal</a>
          </div>
        </div>
      </aside>
    </div>

    <!-- footer / contacto -->
    <footer id="contact">
      <div style="color:#9fd8ea">
        Contacto: <a href="mailto:almacoralma@gmail.com">almacoralma@gmail.com</a>
      </div>
      <div class="socials" aria-label="Redes sociales">
        <a href="https://www.instagram.com/effectno33?igsh=MjAycWE4dTFsbXpw" target="_blank" rel="noopener" title="Instagram">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9zM18.5 6a.9.9 0 1 1 0 1.8.9.9 0 0 1 0-1.8z" fill="#e6f9ff"/></svg>
        </a>
        <a href="https://www.tiktok.com/@effect.33?_t=ZS-8znP36atx8n&_r=1" target="_blank" rel="noopener" title="TikTok">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15 2v7.1a4.5 4.5 0 0 1-4.5-4.5H9A6 6 0 1 0 15 15.9V9h3V2h-3z" fill="#e6f9ff"/></svg>
        </a>
        <a href="https://youtube.com/@effect.no33?si=5A83WFm9vvf_DBRv" target="_blank" rel="noopener" title="YouTube">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M23 7s-.2-1.6-1-2.3c-.9-.9-1.9-.9-2.4-1C16.9 3 12 3 12 3s-4.9 0-7.6.7c-.5.1-1.4.1-2.4 1C1.2 5.4 1 7 1 7S1 8.9 1.1 10.8c.1 1.9.5 2.8 1.1 3.6.9 1.1 2.2 1.1 2.8 1.2 2.1.2 8 .6 8 .6s4.9-.2 7.6-.8c.5-.1 1.9-.1 2.8-1.2.6-.8 1-1.7 1.1-3.6C23 8.9 23 7 23 7zM9.8 15.2V8.8l6 3.2-6 3.2z" fill="#e6f9ff"/></svg>
        </a>
      </div>
    </footer>
  </div>

  <!-- floating sidebar (socials only) -->
  <div class="floating-sidebar" aria-hidden="false">
    <a class="floating-btn" href="https://www.instagram.com/effectno33?igsh=MjAycWE4dTFsbXpw" target="_blank" title="Instagram" rel="noopener" aria-label="Instagram">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9zM18.5 6a.9.9 0 1 1 0 1.8.9.9 0 0 1 0-1.8z" fill="#e6f9ff"/></svg>
    </a>
    <a class="floating-btn" href="https://www.tiktok.com/@effect.33?_t=ZS-8znP36atx8n&_r=1" target="_blank" title="TikTok" rel="noopener" aria-label="TikTok">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M15 2v7.1a4.5 4.5 0 0 1-4.5-4.5H9A6 6 0 1 0 15 15.9V9h3V2h-3z" fill="#e6f9ff"/></svg>
    </a>
    <a class="floating-btn" href="https://youtube.com/@effect.no33?si=5A83WFm9vvf_DBRv" target="_blank" title="YouTube" rel="noopener" aria-label="YouTube">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M23 7s-.2-1.6-1-2.3c-.9-.9-1.9-.9-2.4-1C16.9 3 12 3 12 3s-4.9 0-7.6.7c-.5.1-1.4.1-2.4 1C1.2 5.4 1 7 1 7S1 8.9 1.1 10.8c.1 1.9.5 2.8 1.1 3.6.9 1.1 2.2 1.1 2.8 1.2 2.1.2 8 .6 8 .6s4.9-.2 7.6-.8c.5-.1 1.9-.1 2.8-1.2.6-.8 1-1.7 1.1-3.6C23 8.9 23 7 23 7zM9.8 15.2V8.8l6 3.2-6 3.2z" fill="#e6f9ff"/></svg>
    </a>
  </div>

  <!-- modal -->
  <div id="modalBack" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle"></h2>
      <div id="modalBody" style="color:#dffcff;line-height:1.6"></div>
      <div id="modalRefs" class="refs" style="color:#bfeffd"></div>
      <div style="text-align:right;margin-top:12px">
        <button id="closeModal" class="btn-primary" style="background:transparent;color:#bfeffd;border:1px solid rgba(255,255,255,0.06)">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- webview banner -->
  <div id="webviewBanner" class="webview-banner" role="status">
    Para una mejor experiencia abre esta página en tu navegador (Chrome o Safari).
    <button id="dismissWebview">Cerrar</button>
  </div>

  <!-- floating in-page player (PiP style) -->
  <div id="floatingPlayer" class="floating-player hidden" role="dialog" aria-label="Reproductor en miniatura" tabindex="0">
    <div class="fp-header" id="fpHeader">
      <div class="fp-title" id="fpTitle">Meditación en curso</div>
      <div class="fp-controls" aria-hidden="false">
        <button id="fpToggleSize" title="Agrandar/Reducir" aria-label="Agrandar o reducir">⤢</button>
        <button id="fpPlayPause" title="Pausar/Reanudar" aria-label="Pausar o reanudar">⏯</button>
        <button id="fpClose" title="Cerrar" aria-label="Cerrar">❌</button>
      </div>
    </div>
    <div class="fp-body">
      <img id="fpThumb" src="" alt="Miniatura sesión">
      <div class="fp-meta">
        <div id="fpMetaTitle" style="font-weight:700"></div>
        <div id="fpMetaSub" style="font-size:13px;color:#cfeef7"></div>
      </div>
    </div>
  </div>

<script>
/* CorAlma - Integrated file with floating mini player
   - Floating player: draggable (mouse + touch), expandable, close, play/pause
   - All previous functionality preserved
*/

/* ---------- Utilities ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ---------- WebView banner detection ---------- */
(function showWebviewBannerIfNeeded(){
  const ua = navigator.userAgent || '';
  if(ua.includes('Instagram') || ua.includes('FBAN') || ua.includes('TikTok') || ua.includes('FBAV')){
    $('#webviewBanner').style.display = 'block';
  }
  $('#dismissWebview').addEventListener('click', ()=> $('#webviewBanner').style.display='none');
})();

/* ---------- Music search (Google / YouTube) ---------- */
function searchMusic(type){
  const q = $('#musicQuery').value.trim();
  if(!q) return;
  const query = encodeURIComponent(q + (type === 'google' ? ' música' : ''));
  if(type === 'google'){
    window.open(`https://www.google.com/search?q=${query}`, '_blank', 'noopener');
  } else {
    window.open(`https://www.youtube.com/results?search_query=${query}`, '_blank', 'noopener');
  }
}

/* ---------- Meditation: timer, thumbnail, audio with fallback ---------- */
const audio = $('#audioPlayer');
const sessionThumb = $('#sessionThumb');
const thumbWrap = $('#thumbWrap');
const sessionText = $('#sessionText');
const sessionSub = $('#sessionSub');
const audioNotice = $('#audioNotice');
let timerSeconds = 0;
let timerInterval = null;
let sessionEndsTimeout = null;

const SOUND_URLS = {
  rain: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
    'https://www2.cs.uic.edu/~i101/SoundFiles/BabyElephantWalk60.wav'
  ],
  forest: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3'
  ],
  waves: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
  ],
  binaural: [
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3'
  ]
};

function setTimer(seconds){
  timerSeconds = seconds;
  updateTimeDisplay(seconds);
}

function updateTimeDisplay(sec){
  const mm = String(Math.floor(sec/60)).padStart(2,'0');
  const ss = String(sec % 60).padStart(2,'0');
  $('#timeDisplay').textContent = `${mm}:${ss}`;
}

function tryPlaySrcList(list, idx = 0){
  if(!list || !list[idx]) {
    audioNotice.style.display='block';
    audioNotice.textContent = 'No se encontraron fuentes de audio disponibles.';
    return;
  }
  audio.src = list[idx];
  audio.load();
  const playPromise = audio.play();
  if(playPromise !== undefined){
    playPromise.then(()=> {
      audioNotice.style.display='none';
      // ensure floating player shows correct play state
      setFpPlayState(true);
    }).catch(err => {
      // try next source
      if(idx+1 < list.length){
        tryPlaySrcList(list, idx+1);
      } else {
        audioNotice.style.display='block';
        audioNotice.textContent = 'El navegador bloqueó la reproducción automática. Presiona Iniciar de nuevo o permite reproducción.';
      }
    });
  }
}

/* Start/Stop logic */
function startSessionFromButton(){
  if(!timerSeconds) setTimer(300);
  startMeditation(timerSeconds/60);
}
function startMeditation(minutes){
  if(!minutes) minutes = (timerSeconds/60) || 5;
  const select = $('#soundSelect');
  const soundKey = select.value;
  const img = select.selectedOptions[0].getAttribute('data-img') || 'https://i.imgur.com/Fp6p9VH.png';
  // show thumb area in card
  sessionThumb.src = img;
  sessionText.textContent = `Sonido: ${select.selectedOptions[0].textContent}`;
  sessionSub.textContent = `Duración: ${minutes} min`;
  thumbWrap.style.display = 'flex';

  // floating player: populate and show
  showFloatingPlayer({
    title: select.selectedOptions[0].textContent,
    sub: `${minutes} min`,
    thumb: img
  });

  // start audio with fallback list
  const candidates = SOUND_URLS[soundKey] || [];
  tryPlaySrcList(candidates, 0);

  // set timer UI
  let remaining = Math.round(minutes * 60);
  updateTimeDisplay(remaining);
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    remaining--;
    if(remaining >= 0) updateTimeDisplay(remaining);
    if(remaining <= 0){
      clearInterval(timerInterval);
    }
  }, 1000);

  clearTimeout(sessionEndsTimeout);
  sessionEndsTimeout = setTimeout(()=> {
    audio.pause();
    sessionSub.textContent = 'Sesión finalizada';
    setFpPlayState(false);
    if(!$('#floatingPlayer').classList.contains('hidden')){
      $('#fpMetaSub').textContent = 'Sesión finalizada';
    }
  }, minutes * 60000);
}
function stopMeditation(){
  clearInterval(timerInterval);
  clearTimeout(sessionEndsTimeout);
  audio.pause();
  sessionSub.textContent = 'Sesión detenida';
  updateTimeDisplay(0);
  setFpPlayState(false);
}

/* wire buttons */
$('#startBtn').addEventListener('click', startSessionFromButton);
$('#stopBtn').addEventListener('click', stopMeditation);
$('#medCircle').addEventListener('click', startSessionFromButton);
$('#medCircle').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') startSessionFromButton(); });

/* ---------- Populate sounds list in sidebar ---------- */
function renderSoundsList(){
  const wrap = $('#soundsList');
  wrap.innerHTML = '';
  Object.keys(SOUND_URLS).forEach(k => {
    const opt = document.createElement('div');
    opt.className = 'sound-item';
    opt.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div style="width:42px;height:42px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center">${k[0].toUpperCase()}</div><div style="min-width:120px">${k}</div></div><div><button onclick="selectSound('${k}')">Seleccionar</button></div>`;
    wrap.appendChild(opt);
  });
}
function selectSound(key){
  const sel = $('#soundSelect');
  const opt = Array.from(sel.options).find(o => o.value === key);
  if(opt) { sel.value = key; }
}
renderSoundsList();

/* ---------- Articles dynamic fetching + 15-day rotation ---------- */
const ARTICLES_KEY = 'coralma_articles_v1';
const ARTICLES_DATE_KEY = 'coralma_articles_date_v1';
const ROTATE_DAYS = 15; // rotate every 15 days
const MAX_ARTICLES = 30;

function daysSinceEpoch(date = new Date()){
  return Math.floor(date.getTime() / (1000*60*60*24));
}
function shouldRefreshArticles(){
  const stored = localStorage.getItem(ARTICLES_DATE_KEY);
  if(!stored) return true;
  const saved = parseInt(stored,10);
  const now = daysSinceEpoch();
  return (now - saved) >= ROTATE_DAYS;
}

async function fetchWikipediaTopics(topics = ['Meditation','Mindfulness','Neuroscience','Mind–body_interventions','Gratitude']){
  const results = [];
  for (const t of topics) {
    const api = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(t)}`;
    try {
      const res = await fetch(api);
      if(!res.ok) continue;
      const json = await res.json();
      if(json && json.title) {
        results.push({
          source: 'Wikipedia',
          title: json.title,
          extract: json.extract || '',
          url: json.content_urls ? json.content_urls.desktop.page : `https://en.wikipedia.org/wiki/${encodeURIComponent(t)}`,
          content: json.extract || ''
        });
      }
    } catch(e){}
  }
  return results;
}

async function fetchRedditPosts(subreddits = ['Meditation','Philosophy']){
  const results = [];
  for(const s of subreddits){
    const api = `https://www.reddit.com/r/${s}/hot.json?limit=8`;
    try {
      const res = await fetch(api);
      if(!res.ok) continue;
      const json = await res.json();
      if(json && json.data && json.data.children){
        for(const ch of json.data.children){
          const d = ch.data;
          results.push({
            source: `r/${s}`,
            title: d.title,
            extract: (d.selftext && d.selftext.substring(0,300)) || '',
            url: `https://reddit.com${d.permalink}`,
            content: d.selftext || ''
          });
        }
      }
    } catch(e){}
  }
  return results;
}

async function fetchArxiv(query='mindfulness OR meditation', max=12) {
  try {
    const api = `https://export.arxiv.org/api/query?search_query=all:${encodeURIComponent(query)}&start=0&max_results=${max}`;
    const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(api)}`);
    if(!res.ok) return [];
    const text = await res.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(text, "application/xml");
    const entries = xml.querySelectorAll('entry');
    const results = [];
    entries.forEach(entry => {
      const title = entry.querySelector('title')?.textContent || '';
      const summary = entry.querySelector('summary')?.textContent || '';
      const id = entry.querySelector('id')?.textContent || '';
      results.push({
        source: 'arXiv',
        title: title.trim(),
        extract: (summary || '').trim(),
        url: id,
        content: summary || ''
      });
    });
    return results;
  } catch(e){ return []; }
}

async function buildArticles(){
  const articles = [];
  const [w, r, a] = await Promise.all([
    fetchWikipediaTopics(),
    fetchRedditPosts(),
    fetchArxiv()
  ]);
  articles.push(...w, ...r, ...a);
  const shuffled = articles.sort(()=>0.5 - Math.random()).slice(0, MAX_ARTICLES);
  return shuffled;
}

async function ensureArticles(){
  if(!shouldRefreshArticles()){
    const cached = localStorage.getItem(ARTICLES_KEY);
    if(cached) {
      try {
        return JSON.parse(cached);
      } catch(e){}
    }
  }
  const arts = await buildArticles();
  localStorage.setItem(ARTICLES_KEY, JSON.stringify(arts));
  localStorage.setItem(ARTICLES_DATE_KEY, daysSinceEpoch().toString());
  return arts;
}

/* ---------- Render articles ---------- */
function createArticleCard(a, idx){
  const div = document.createElement('div');
  div.className = 'article-card';
  const title = document.createElement('h3');
  title.textContent = a.title;
  const p = document.createElement('p');
  p.textContent = a.extract ? (a.extract.length > 220 ? a.extract.substring(0,220)+'…' : a.extract) : '(sin resumen)';
  const read = document.createElement('button');
  read.className = 'read-btn';
  read.textContent = 'Leer';
  read.onclick = ()=> openModal(a);
  div.appendChild(title);
  div.appendChild(p);
  div.appendChild(read);
  return div;
}

async function renderArticles(){
  const grid = $('#articlesGrid');
  grid.innerHTML = '';
  const loading = document.createElement('div');
  loading.textContent = 'Cargando artículos…';
  grid.appendChild(loading);
  const articles = await ensureArticles();
  grid.innerHTML = '';
  if(!articles || !articles.length){
    grid.innerHTML = '<div class="article-card">No se pudieron cargar artículos.</div>';
    return;
  }
  articles.forEach((a, i) => {
    const c = createArticleCard(a, i);
    grid.appendChild(c);
  });
}

/* ---------- Modal handling ---------- */
function openModal(article){
  $('#modalTitle').textContent = `${article.title} — ${article.source}`;
  $('#modalBody').textContent = article.content || article.extract || '(sin contenido completo)';
  const refs = document.getElementById('modalRefs');
  refs.innerHTML = `<div>Fuente: <a href="${article.url}" target="_blank" rel="noopener">${article.url}</a></div>`;
  $('#modalBack').classList.add('on');
  $('#modalBack').setAttribute('aria-hidden','false');
}
$('#closeModal').addEventListener('click', ()=> {
  $('#modalBack').classList.remove('on');
  $('#modalBack').setAttribute('aria-hidden','true');
});

/* ---------- Floating player (drag, touch, expand, controls) ---------- */
const fp = $('#floatingPlayer');
const fpHeader = $('#fpHeader');
const fpThumb = $('#fpThumb');
const fpTitle = $('#fpMetaTitle');
const fpSub = $('#fpMetaSub');
const fpToggleSize = $('#fpToggleSize');
const fpPlayPause = $('#fpPlayPause');
const fpClose = $('#fpClose');

let isFpVisible = false;
let isFpExpanded = false;
let isDragging = false;
let dragOffset = {x:0,y:0};

// Show / populate floating player
function showFloatingPlayer({title, sub, thumb}){
  fpTitle.textContent = title || 'Meditación';
  fpSub.textContent = sub || '';
  fpThumb.src = thumb || '';
  if(fp.classList.contains('hidden')) fp.classList.remove('hidden');
  isFpVisible = true;
  // bring to front
  fp.style.zIndex = 9999;
}

// Set play/pause icon and accessible label
function setFpPlayState(playing){
  fpPlayPause.textContent = playing ? '⏸' : '▶️';
  fpPlayPause.setAttribute('aria-pressed', playing ? 'true' : 'false');
}

// Toggle expanded state
fpToggleSize.addEventListener('click', ()=>{
  isFpExpanded = !isFpExpanded;
  if(isFpExpanded) fp.classList.add('expanded'); else fp.classList.remove('expanded');
});

// Play/Pause control: control the hidden audio element
fpPlayPause.addEventListener('click', ()=>{
  if(audio.paused){
    audio.play().then(()=> setFpPlayState(true)).catch(()=>{/* ignore */});
  } else {
    audio.pause();
    setFpPlayState(false);
  }
});

// Close: hide player but keep audio playing (or stop? we close only UI)
fpClose.addEventListener('click', ()=>{
  fp.classList.add('hidden');
  isFpVisible = false;
});

// Update play state when audio pauses/plays
audio.addEventListener('play', ()=> setFpPlayState(true));
audio.addEventListener('pause', ()=> setFpPlayState(false));

// Drag: mouse
fpHeader.addEventListener('mousedown', (ev)=>{
  isDragging = true;
  dragOffset.x = ev.clientX - fp.getBoundingClientRect().left;
  dragOffset.y = ev.clientY - fp.getBoundingClientRect().top;
  fp.style.cursor = 'grabbing';
});
document.addEventListener('mouseup', ()=> { isDragging = false; fp.style.cursor = 'grab'; });
document.addEventListener('mousemove', (ev)=>{
  if(!isDragging) return;
  ev.preventDefault();
  const nx = Math.max(8, Math.min(window.innerWidth - fp.offsetWidth - 8, ev.clientX - dragOffset.x));
  const ny = Math.max(8, Math.min(window.innerHeight - fp.offsetHeight - 8, ev.clientY - dragOffset.y));
  fp.style.right = 'auto';
  fp.style.left = nx + 'px';
  fp.style.top = ny + 'px';
});

// Drag: touch
fpHeader.addEventListener('touchstart', (ev)=>{
  isDragging = true;
  const t = ev.touches[0];
  dragOffset.x = t.clientX - fp.getBoundingClientRect().left;
  dragOffset.y = t.clientY - fp.getBoundingClientRect().top;
});
document.addEventListener('touchend', ()=> { isDragging = false; });
document.addEventListener('touchmove', (ev)=>{
  if(!isDragging) return;
  const t = ev.touches[0];
  const nx = Math.max(8, Math.min(window.innerWidth - fp.offsetWidth - 8, t.clientX - dragOffset.x));
  const ny = Math.max(8, Math.min(window.innerHeight - fp.offsetHeight - 8, t.clientY - dragOffset.y));
  fp.style.right = 'auto';
  fp.style.left = nx + 'px';
  fp.style.top = ny + 'px';
});

/* Helper: update floating player meta when session starts/ends */
function updateFloatingMeta(title, sub){
  if(!isFpVisible) return;
  $('#fpMetaTitle').textContent = title;
  $('#fpMetaSub').textContent = sub;
}

/* ---------- Init & bindings ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  renderArticles();
  updateTimeDisplay(0);

  $('#subForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const email = $('#emailInput').value.trim();
    if(!email) { $('#subInfo').textContent = 'Ingresa un correo válido.'; return; }
    $('#subInfo').textContent = '¡Gracias! Te hemos inscrito (demo).';
    $('#emailInput').value = '';
  });
});
</script>
</body>
</html>